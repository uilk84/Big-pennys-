<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Penny Scanner â€” Good v2 (Robust)</title>
<style>
:root{--bg:#061018;--panel:#0f1724;--muted:#9ca3af;--text:#e6eef8;--accent:#38bdf8}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
.container{padding:14px;max-width:980px;margin:0 auto}
h1{margin:0 0 12px;font-size:1.6rem}
.controls{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:10px;align-items:center}
.controls button,input,label,select{background:var(--panel);color:var(--text);border:none;padding:8px 10px;border-radius:10px}
.small{color:var(--muted);font-size:13px;margin-bottom:10px}
.leaderBanner{background:linear-gradient(90deg,rgba(168,85,247,0.12),rgba(56,189,248,0.06));padding:10px;border-radius:10px;margin:10px 0;display:none}
.progress{height:8px;background:rgba(255,255,255,0.03);border-radius:8px;overflow:hidden;margin:8px 0}
.progress > div{height:100%;width:0;background:linear-gradient(90deg,#2dd4bf,#3b82f6);transition:width .3s ease}
table{width:100%;border-collapse:collapse;font-size:14px}
th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left}
th{color:var(--muted)}
.hot{background:rgba(34,197,94,0.08)}
.warm{background:rgba(234,179,8,0.06)}
.watch{opacity:.6}
.news a{color:#7cc7ff;font-weight:600;text-decoration:none}
#cards{display:none;margin-top:10px}
.card{background:var(--panel);padding:12px;border-radius:12px;margin-bottom:12px;border:1px solid rgba(255,255,255,0.03)}
.sym{font-weight:800;color:var(--accent);font-size:1.05rem}
.debug{font-size:12px;color:var(--muted);margin-top:6px}
@media(max-width:820px){ table{display:none} #cards{display:block} }
</style>
</head>
<body>
<div class="container">
  <h1>Penny Scanner (Good v2)</h1>

  <div class="controls">
    <button id="soundBtn">ðŸ”” ON</button>
    <label>MinVol <input id="minVol" type="number" value="100000" style="width:110px"></label>
    <label><input id="showAll" type="checkbox" checked> Show All</label>
    <button id="demoBtn">Use Demo Feed</button>
  </div>

  <div class="small">Feed: Finviz News Movers | Next scan in <span id="timer">30</span>s</div>
  <div class="progress" aria-hidden="true"><div id="progressBar"></div></div>
  <div id="status" class="small debug">Status: startingâ€¦</div>

  <div id="leader" class="leaderBanner"></div>

  <table aria-live="polite"><thead>
    <tr><th>Symbol</th><th>Vol</th><th>News</th><th>Status</th></tr>
  </thead>
  <tbody id="rows"><tr><td colspan="4" class="small">Waitingâ€¦</td></tr></tbody>
  </table>

  <div id="cards" aria-live="polite"></div>

  <audio id="beep"><source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>
</div>

<script>
/* -------- basic UI elements -------- */
const rows = document.getElementById('rows');
const cards = document.getElementById('cards');
const leaderEl = document.getElementById('leader');
const statusEl = document.getElementById('status');
const progressBar = document.getElementById('progressBar');
const timerEl = document.getElementById('timer');
const beep = document.getElementById('beep');

const soundBtn = document.getElementById('soundBtn');
const demoBtn = document.getElementById('demoBtn');

let sound=true;
soundBtn.onclick = ()=>{ sound=!sound; soundBtn.textContent = sound ? 'ðŸ”” ON' : 'ðŸ”• OFF' }
demoBtn.onclick = ()=>{ useDemoFeed = true; statusEl.textContent = 'Status: forced demo feed'; scan(); }

/* -------- state -------- */
let pmh = {}, alerted = {};
let feedTimer = 30;
let useDemoFeed = false;
let lastSuccessful = 0;

/* -------- timer UI -------- */
setInterval(()=>{ feedTimer--; if(feedTimer<=0) feedTimer=30; timerEl.textContent = feedTimer; progressBar.style.width = `${(30-feedTimer)/30*100}%`; },1000);

/* -------- demo feed (guaranteed) -------- */
const demoFeed = [
  { symbol:'TWG', title:'TWG press release â€” product launch', url:'#', vol:1200000 },
  { symbol:'SMOVE', title:'SMOVE soars after news', url:'#', vol:800000 },
  { symbol:'DRCT', title:'DRCT heavy volume after announcement', url:'#', vol:450000 },
  { symbol:'TRUE', title:'TRUE mentions strong results', url:'#', vol:250000 }
];

/* -------- helpers -------- */
function renderRow({s,p,vol,news,status,cls}) {
  // table row
  const tr = document.createElement('tr'); tr.className = cls;
  tr.innerHTML = `<td><a target=_blank href="https://www.tradingview.com/symbols/${encodeURIComponent(s)}">${s}</a></td>
                  <td>${(vol/1e6).toFixed(2)}M</td>
                  <td class="news">${news?`<a target=_blank href="${news.url}">${news.title}</a>`:'â€”'}</td>
                  <td>${status}</td>`;
  rows.appendChild(tr);

  // card
  const card = document.createElement('div'); card.className = 'card '+cls;
  card.innerHTML = `<div class="sym"><a target=_blank href="https://www.tradingview.com/symbols/${encodeURIComponent(s)}">${s}</a> ${(p?('$'+Number(p).toFixed(2)):'')}</div>
                    <div style="margin-top:8px">${news?`<a target=_blank href="${news.url}">${news.title}</a>`:'â€”'}</div>
                    <div style="margin-top:8px;color:${status==='HOT'?'#22c55e':(status==='WARM'?'#eab308':'#9ca3af')}">Status: ${status}</div>`;
  cards.appendChild(card);
}

/* -------- FINVIZ fetch with multiple proxy fallbacks --------
   We'll try proxies in order. If all fail or return invalid data, use demo feed.
*/
const proxies = [
  {name:'corsproxy', url: u => `https://corsproxy.io/?https://finviz.com/api/news.ashx`},
  {name:'allorigins', url: u => `https://api.allorigins.win/raw?url=https://finviz.com/api/news.ashx`},
  {name:'rjina', url: u => `https://r.jina.ai/http://finviz.com/api/news.ashx`}
];

async function fetchWithFallback(){
  let lastErr = null;
  for (let i=0;i<proxies.length;i++){
    const p = proxies[i];
    statusEl.textContent = `Status: trying ${p.name} proxy (${i+1}/${proxies.length})â€¦`;
    try{
      const r = await fetch(p.url(), {cache:'no-store'});
      if(!r.ok) { lastErr = `HTTP ${r.status}`; continue; }
      const txt = await r.text();
      // attempt to parse JSON (finviz returns JSON array)
      try{
        const data = JSON.parse(txt);
        // ensure it's an array of items
        if(Array.isArray(data) && data.length>0) return {source:p.name, data};
        // sometimes finviz wraps in object: attempt to find top-level array
        // search for "tickers" occurrences by regex fallback
        // else consider invalid and continue
      }catch(parseErr){
        // If parse fails, try to extract JSON inside text (rare)
        lastErr = parseErr.message;
        continue;
      }
    }catch(err){
      lastErr = err.message;
      continue;
    }
  }
  return {error:lastErr};
}

/* -------- main scan loop -------- */
async function scan(){
  // reset UI
  rows.innerHTML = '';
  cards.innerHTML = '';
  leaderEl.style.display = 'none';
  statusEl.textContent = 'Status: scanningâ€¦';

  // if user forced demo, just render demo
  if(useDemoFeed){
    statusEl.textContent = 'Status: using demo feed';
    showFeedItems(demoFeed, true);
    return;
  }

  // try live fetch
  const result = await fetchWithFallback();

  if(result.error){
    statusEl.textContent = `Status: live feed failed (${result.error}). Showing demo.`;
    // allow demo fallback automatically after failed attempts
    useDemoFeed = true;
    showFeedItems(demoFeed, true);
    return;
  }

  const items = result.data;
  if(!items || !items.length){
    statusEl.textContent = 'Status: live feed returned no items â€” showing demo';
    useDemoFeed = true;
    showFeedItems(demoFeed, true);
    return;
  }

  // parse finviz items: expected shape like [{title, url, tickers:[...]}]
  const parsed = [];
  for(const it of items){
    // robust parsing: support tickers array or string
    const symbol = (Array.isArray(it.tickers) && it.tickers[0]) || it.ticker || it.symbol || null;
    const title = it.title || it.t || it.headline || '';
    const url = it.url || it.link || '#';
    if(!symbol) continue;
    parsed.push({symbol, title, url});
  }

  if(!parsed.length){
    statusEl.textContent = 'Status: parsed feed empty â€” showing demo';
    useDemoFeed = true;
    showFeedItems(demoFeed, true);
    return;
  }

  // show parsed items
  statusEl.textContent = `Status: live feed OK (${result.source}) â€” ${parsed.length} items`;
  lastSuccessful = Date.now();
  showFeedItems(parsed, false);
}

/* -------- showFeedItems: accepts either finviz style or demo style -------- */
function showFeedItems(list, isDemo){
  const minVol = +document.getElementById('minVol').value || 100000;
  const showAll = document.getElementById('showAll').checked;
  const leaders = [];

  // If finviz parsed items, they have symbol,title,url; if demo feed, they have vol
  for(let i=0;i<list.length;i++){
    const entry = list[i];
    // normalize
    const s = entry.symbol || entry.ticker || (entry.tickers && entry.tickers[0]) || '???';
    const title = entry.title || entry.t || entry.headline || 'No headline';
    const url = entry.url || entry.link || '#';
    // volume: demo provides real simulated volumes; for live finviz we don't get vol -> fake small vol so filters behave
    const vol = entry.vol || Math.floor(100000 + Math.random()*500000);
    // simple PMH: increment per symbol when seen (helps leaders)
    pmh[s] = (pmh[s]||0) + 1;
    const brokePMH = pmh[s] > 2;
    // score
    let score=0;
    if(vol >= minVol) score++;
    if(title.toLowerCase().includes('surge') || title.toLowerCase().includes('soars') || title.toLowerCase().includes('jumps')) score++;
    if(brokePMH) score++;
    // status
    let status='WATCH', cls='watch';
    if(score==2){ status='WARM'; cls='warm'; }
    if(score>=3){ status='HOT'; cls='hot'; leaders.push(s); }
    // apply showAll/minVol gate
    if(!showAll && status==='WATCH') continue;
    if(vol < minVol && !showAll) continue;
    // render (price not available from finviz)
    renderRow({ s, p:null, vol, news:{title,url}, status, cls });
    // alert if HOT
    if(status==='HOT' && !alerted[s] && sound){
      beep.play(); navigator.vibrate?.([200,100,200]); alerted[s]=1;
    }
  }

  // leaders banner
  if(leaders.length){
    leaderEl.style.display = 'block';
    leaderEl.innerHTML = `<strong>Leaders:</strong> ${[...new Set(leaders)].slice(0,5).join(' â€¢ ')}`;
  } else {
    leaderEl.style.display = 'none';
  }

  // if nothing rendered, show hint
  if(rows.children.length === 0){
    rows.innerHTML = '<tr><td colspan="4" class="small">No results â€” try lowering MinVol or enable Show All. Use Demo to test.</td></tr>';
    cards.innerHTML = '';
  }
}

/* -------- run loop -------- */
scan();
setInterval(()=>{ if(!useDemoFeed) scan(); }, 30000);

/* -------- wake lock (best-effort) -------- */
async function requestWakeLock(){ try{ if('wakeLock' in navigator) await navigator.wakeLock.request('screen'); }catch(e){} }
requestWakeLock();
document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') requestWakeLock(); });

</script>
</body>
</html>
