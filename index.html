<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Penny Scanner v4 â€” Key-friendly</title>
<style>
  :root{--bg:#0e1720;--card:#0f1a23;--muted:#98a1ad;--link:#6cc3ff;--text:#e7eef6;--hot:#ffd166;--warm:#ffb86b;--good:#3ce88a}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial}
  .wrap{max-width:820px;margin:14px auto;padding:14px}
  h1{font-size:30px;margin:0 0 12px}
  .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:12px}
  .btn,input[type=text],select{background:linear-gradient(#0b1216,#0d161b);border:1px solid rgba(255,255,255,0.03);color:var(--text);padding:10px;border-radius:10px}
  input.small{width:140px}
  label{color:var(--muted);display:flex;align-items:center;gap:8px}
  .bar{height:6px;background:linear-gradient(90deg,#21c9d6,#6b5dff);border-radius:6px;margin:6px 0}
  .list{display:grid;gap:12px;margin-top:12px}
  .card{background:var(--card);padding:14px;border-radius:12px}
  .ticker{font-weight:700;color:var(--link);font-size:18px}
  .meta{color:var(--muted);margin-top:6px}
  .rightBadge{float:right;background:rgba(255,255,255,0.03);padding:6px 8px;border-radius:8px}
  pre.debug{background:#071018;color:#9ed1ff;padding:12px;border-radius:10px;overflow:auto;margin-top:12px}
  .keys{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .kbox{display:flex;flex-direction:column;gap:6px}
  .muted{color:var(--muted)}
  a{color:var(--link)}
</style>
</head>
<body>
  <div class="wrap">
    <h1>ðŸ“ˆ Penny Scanner v4 (keys on-device)</h1>

    <div class="controls">
      <button id="scanNow" class="btn">Scan Now</button>
      <button id="forceDemo" class="btn">Force Demo</button>
      <label><input id="showAll" type="checkbox" checked /> Show All</label>
      <label><input id="prOnly" type="checkbox" /> PR Only</label>
      <input id="minVol" class="small" type="text" value="100000" />
    </div>

    <div class="muted">Paste your API keys below and click <strong>Save Keys</strong>. Keys are stored locally on your phone (in browser storage) â€” not uploaded anywhere.</div>

    <div class="keys">
      <div class="kbox">
        <label>FinancialModelingPrep Key (FMP)</label>
        <input id="fmpKey" type="text" placeholder="FMP API key (paste here)" />
      </div>
      <div class="kbox">
        <label>Finnhub Key (optional)</label>
        <input id="finnKey" type="text" placeholder="Finnhub key (optional)" />
      </div>
      <div style="display:flex;align-items:flex-end;gap:8px">
        <button id="saveKeys" class="btn">Save Keys</button>
        <button id="clearKeys" class="btn">Clear Keys</button>
      </div>
    </div>

    <div class="status" id="status" style="margin-top:8px;color:var(--muted)">Feed: â€” | Next scan: â€”</div>
    <div class="bar" id="progress" style="width:0%"></div>
    <div style="margin-top:8px;color:var(--good)" id="leader">Leader: â€”</div>

    <div class="list" id="list"></div>

    <pre id="debug" class="debug"></pre>
  </div>

<script>
/* ---------- demo + utilities ---------- */
const DEMO = [
  {symbol:'SMOVE', price:3.42, vol:800000, title:'SMOVE surges after press release', status:'HOT'},
  {symbol:'TWG', price:5.11, vol:1200000, title:'TWG launches new product', status:'WARM'},
  {symbol:'DRCT', price:2.95, vol:450000, title:'DRCT heavy volume after announcement', status:'WARM'},
  {symbol:'TRUE', price:1.88, vol:250000, title:'TRUE reports earnings', status:'WATCH'}
];

const SCAN_INTERVAL = 30; // seconds
let nextScan = SCAN_INTERVAL;
let autoTimer = null;
let useDemo = false;
let lastLeader = '';

/* DOM */
const listEl = document.getElementById('list');
const debugEl = document.getElementById('debug');
const statusEl = document.getElementById('status');
const progressEl = document.getElementById('progress');
const leaderEl = document.getElementById('leader');

const fmpField = document.getElementById('fmpKey');
const finnField = document.getElementById('finnKey');
const saveBtn = document.getElementById('saveKeys');
const clearBtn = document.getElementById('clearKeys');
const scanBtn = document.getElementById('scanNow');
const forceDemoBtn = document.getElementById('forceDemo');

/* load saved keys from localStorage on load */
(function loadKeys(){
  try {
    const f = localStorage.getItem('fmp_key') || '';
    const fi = localStorage.getItem('finnhub_key') || '';
    fmpField.value = f;
    finnField.value = fi;
    if(f) log('Using saved FMP key from device (not repo).');
  } catch(e){}
})();

function log(...args){ debugEl.textContent = args.map(x => (typeof x==='object'?JSON.stringify(x,null,2):String(x))).join('\\n\\n'); }

function formatVol(v){ if(!v) return '0'; if(v>=1e6) return (v/1e6).toFixed(2)+'M'; if(v>=1e3) return (v/1e3).toFixed(0)+'K'; return String(v); }
function formatPrice(p){ return (Number(p)||0).toFixed(2); }

/* ---------- saving & clearing keys ---------- */
saveBtn.addEventListener('click', ()=>{
  try {
    localStorage.setItem('fmp_key', fmpField.value.trim());
    localStorage.setItem('finnhub_key', finnField.value.trim());
    alert('Keys saved locally. Scanning now...');
    doScan(true);
  } catch(e){
    alert('Failed to save keys: '+e.message);
  }
});
clearBtn.addEventListener('click', ()=>{
  if(confirm('Clear saved keys from this browser?')){
    localStorage.removeItem('fmp_key'); localStorage.removeItem('finnhub_key');
    fmpField.value=''; finnField.value='';
    alert('Keys cleared. The page will use DEMO if live calls fail.');
    doScan(true);
  }
});

/* ---------- fetch helpers that read localStorage keys ---------- */
function getFmpKey(){ return localStorage.getItem('fmp_key') || fmpField.value.trim() || ''; }
function getFinnKey(){ return localStorage.getItem('finnhub_key') || finnField.value.trim() || ''; }

/* FMP gainers endpoint (v3) */
async function fetchFmpGainers(){
  const key = getFmpKey();
  const url = key ? `https://financialmodelingprep.com/api/v3/stock_market/gainers?apikey=${encodeURIComponent(key)}` : 'https://financialmodelingprep.com/api/v3/stock_market/gainers';
  const res = await fetch(url);
  if(!res.ok){
    const text = await res.text().catch(()=>'<no body>');
    throw {source:'FMP gainers', status:res.status, text};
  }
  return res.json();
}

/* FMP actives fallback */
async function fetchFmpActives(){
  const key = getFmpKey();
  const url = key ? `https://financialmodelingprep.com/api/v3/stock_market/actives?apikey=${encodeURIComponent(key)}` : 'https://financialmodelingprep.com/api/v3/stock_market/actives';
  const res = await fetch(url);
  if(!res.ok){
    const text = await res.text().catch(()=>'<no body>');
    throw {source:'FMP actives', status:res.status, text};
  }
  return res.json();
}

/* Finnhub per-symbol quote fallback (if user provides finnhub key) */
async function fetchFinnhubQuote(symbol){
  const key = getFinnKey();
  if(!key) throw {source:'Finnhub', status:'no_key', text:'No finnhub key provided'};
  const url = `https://finnhub.io/api/v1/quote?symbol=${encodeURIComponent(symbol)}&token=${encodeURIComponent(key)}`;
  const res = await fetch(url);
  if(!res.ok) throw {source:'Finnhub quote', status:res.status, text: await res.text()};
  return res.json();
}

/* normalize FMP item -> our shape */
function normalizeFmp(item){
  return {
    symbol: item.symbol || item.ticker || item.symbol,
    price: item.price || item.open || item.previousClose || 0,
    vol: item.volume || item.volume || 0,
    title: item.name || item.companyName || (item.symbol || '') + ' mover',
    status: (item.changesPercentage && Math.abs(Number(item.changesPercentage))>10) ? 'HOT' : (item.changesPercentage && Math.abs(Number(item.changesPercentage))>3) ? 'WARM' : 'WATCH'
  };
}

/* ---------- render ---------- */
function render(items, feedUsed){
  listEl.innerHTML = '';
  if(!items || items.length === 0){
    listEl.innerHTML = '<div class="card">No results</div>';
    leaderEl.textContent = 'Leader: â€”';
    return;
  }
  items.forEach((it, idx) => {
    const card = document.createElement('div'); card.className='card';
    const badge = document.createElement('div'); badge.className='rightBadge'; badge.textContent = (idx+1);
    card.appendChild(badge);
    const ticker = document.createElement('div'); ticker.className='ticker'; ticker.innerHTML = `<a href="#" onclick="return false">${it.symbol} <span style="color:var(--text)">$${formatPrice(it.price)}</span></a>`; card.appendChild(ticker);
    const title = document.createElement('div'); title.className='meta'; title.textContent = it.title || ''; card.appendChild(title);
    const meta = document.createElement('div'); meta.className='meta'; meta.innerHTML = `Vol: ${formatVol(it.vol)} | Status: <strong>${it.status||'â€”'}</strong>`; card.appendChild(meta);
    const link = document.createElement('div'); link.style.marginTop='8px'; link.innerHTML = `<a href="#" onclick="event.preventDefault();window.open('https://www.tradingview.com/symbols/${encodeURIComponent(it.symbol)}/','_blank')">ðŸ“ˆ Chart</a>`;
    card.appendChild(link);
    listEl.appendChild(card);
  });
  leaderEl.textContent = 'Leader: ' + (items[0]?.symbol || 'â€”');
  statusEl.textContent = `Feed: ${feedUsed} | Next scan: ${nextScan}s`;
}

/* ---------- apply filters ---------- */
function applyFilters(items){
  const minVol = Number(document.getElementById('minVol').value||0);
  const prOnly = document.getElementById('prOnly').checked;
  const showAll = document.getElementById('showAll').checked;
  return (items||[]).filter(it=>{
    if(!showAll && (!it.price || it.price < 0.01)) return false;
    if(minVol && (Number(it.vol) || 0) < minVol) return false;
    if(prOnly && !/press|press release|pr/i.test(it.title || '')) return false;
    return true;
  });
}

/* ---------- scan with rotation/fallback ---------- */
async function doScan(manual=false){
  if(useDemo && !manual){
    render(DEMO, 'DEMO (forced)');
    return;
  }
  // try FMP gainers -> FMP actives -> Finnhub per-symbol -> demo
  const errors = [];
  try {
    const g = await fetchFmpGainers();
    const items = (Array.isArray(g)?g:[]).slice(0,40).map(normalizeFmp);
    const filtered = applyFilters(items);
    if(filtered.length === 0) throw {source:'fmp_gainers', status:'no_items'};
    render(filtered, 'FMP: gainers');
    log({used:'fmp_gainers',count:filtered.length});
    return;
  } catch (e1) {
    errors.push(e1);
    try {
      const a = await fetchFmpActives();
      const items = (Array.isArray(a)?a:[]).slice(0,40).map(normalizeFmp);
      const filtered = applyFilters(items);
      if(filtered.length === 0) throw {source:'fmp_actives', status:'no_items'};
      render(filtered, 'FMP: actives');
      log({used:'fmp_actives',count:filtered.length});
      return;
    } catch (e2) {
      errors.push(e2);
      // try finn hub quotes for small list if key present
      const finnKey = getFinnKey();
      if(finnKey){
        try {
          const syms = ['SMOVE','TWG','DRCT','TRUE'];
          const qps = syms.map(s => fetchFinnhubQuote(s).then(q=>{
            return {symbol:s, price:q.c||0, vol:q.v||0, title:s + ' quote', status:(q.dp && Math.abs(q.dp)>5)?'HOT':'WARM'};
          }).catch(err=>null));
          const resolved = (await Promise.all(qps)).filter(Boolean);
          const filtered = applyFilters(resolved);
          if(filtered.length){
            render(filtered, 'Finnhub quotes');
            log({used:'finnhub_quotes',count:filtered.length});
            return;
          }
        } catch(e3){
          errors.push(e3);
        }
      }
      // final fallback demo
      render(DEMO, 'DEMO (api failed)');
      log({error:errors, fallback:'demo'});
      return;
    }
  }
}

/* ---------- log helper, plus improved 403 hint ---------- */
function log(obj){
  // pretty debug text
  try {
    const text = JSON.stringify(obj,null,2);
    debugEl.textContent = text;
    // if any error includes 403 with "Legacy", add guided hint:
    const s = text.toLowerCase();
    if(s.includes('403') && s.includes('legacy')){
      debugEl.textContent += "\\n\\nHINT: FMP returned 403 with 'Legacy Endpoint' â€” that means the key you used (or no key) does not have access to old endpoints. Paste a current FMP key (or use a Finnhub key) and press Save Keys. If you don't have a paid FMP account, use Finnhub or leave demo on.";
    }
  } catch(e){
    debugEl.textContent = String(obj);
  }
}

/* ---------- auto-scan timer ---------- */
function startAuto(){
  if(autoTimer) clearInterval(autoTimer);
  nextScan = SCAN_INTERVAL;
  autoTimer = setInterval(()=>{
    nextScan--;
    const pct = ((SCAN_INTERVAL - nextScan)/SCAN_INTERVAL)*100;
    progressEl.style.width = pct + '%';
    statusEl.textContent = `Next scan in: ${nextScan}s`;
    if(nextScan<=0){
      doScan();
      nextScan = SCAN_INTERVAL;
    }
  },1000);
}

/* ---------- UI hookups ---------- */
scanBtn.addEventListener('click', ()=>{ nextScan=0; doScan(true); });
forceDemoBtn.addEventListener('click', ()=>{ useDemo = !useDemo; forceDemoBtn.textContent = useDemo ? 'Demo: ON' : 'Force Demo'; doScan(true); });

/* run on load */
startAuto();
doScan();

/* expose to console for quick testing */
window.doScan = doScan;
window.showDemo = ()=>{ render(DEMO,'DEMO (manual)'); };

</script>
</body>
</html>
