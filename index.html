<script>
/* ================= DOM ================= */
const rows = document.getElementById("rows");
const beep = document.getElementById("beep");
const soundBtn = document.getElementById("soundBtn");
const sessionLabel = document.getElementById("sessionLabel");

/* ================= STATE ================= */
let soundOn = true;
let hod = {}, lastVol = {}, base = {}, alerted = {};

/* ================= SOUND ================= */
soundBtn.onclick = () => {
  soundOn = !soundOn;
  soundBtn.innerText = soundOn ? "ðŸ”” Sound: ON" : "ðŸ”• Sound: OFF";
};

/* ================= PRESETS ================= */
function setPreset(type){
  if(type==="lotto"){minPrice.value=0.10;maxPrice.value=1.00;}
  if(type==="scalp"){minPrice.value=0.30;maxPrice.value=3.00;}
  if(type==="momentum"){minPrice.value=1.00;maxPrice.value=10.00;}
  scan();
}

/* ================= SESSION ================= */
function currentSession(){
  const d=new Date(new Date().toLocaleString("en-US",{timeZone:"America/New_York"}));
  const h=d.getHours()+d.getMinutes()/60;
  if(h>=4&&h<9.5) return "PRE";
  if(h>=9.5&&h<16) return "MARKET";
  if(h>=16&&h<=20) return "POST";
  return "CLOSED";
}
function sessionAllowed(){
  const s=currentSession();
  if(s==="PRE") return pre.checked;
  if(s==="MARKET") return true;
  if(s==="POST") return post.checked;
  return false;
}

/* ================= SCAN ================= */
async function scan(){
  const s=currentSession();
  sessionLabel.innerText=s;

  if(!sessionAllowed()){
    rows.innerHTML=`<tr><td colspan="9" class="small">Session mismatch â€” ${s}</td></tr>`;
    return;
  }

  const minP = +minPrice.value;
  const maxP = +maxPrice.value;
  const maxRisk = +riskPerTrade.value;

  try{
    const res=await fetch(
      "https://corsproxy.io/?https://query1.finance.yahoo.com/v1/finance/screener/predefined/saved?count=50&scrIds=day_gainers"
    );
    const list=(await res.json())?.finance?.result?.[0]?.quotes||[];

    rows.innerHTML="";
    let fired=false;

    list.forEach(t=>{
      const sym=t.symbol, price=t.regularMarketPrice, vol=t.regularMarketVolume||0;
      if(!sym||!price) return;
      if(price<minP||price>maxP) return;

      const prevH=hod[sym]||0, prevV=lastVol[sym]||0;
      hod[sym]=Math.max(prevH,price);
      lastVol[sym]=vol;

      base[sym]=price>prevH?(prevH||price):(base[sym]||price);

      const breakout=price>prevH;
      const volAccel=vol>prevV*1.25;
      const strongVol=vol>=1500000;

      const stop=+(base[sym]*0.97).toFixed(2);
      const riskPerShare=+(price-stop).toFixed(2);
      if(riskPerShare<=0) return;

      const shares=Math.floor(maxRisk/riskPerShare);
      const dollarRisk=+(shares*riskPerShare).toFixed(2);
      const target=+(price+riskPerShare*2).toFixed(2);
      const reward=+((target-price)*shares).toFixed(2);
      const rr=reward>0?+(reward/dollarRisk).toFixed(2):0;

      let grade="NO", cls="notrade";

      if(breakout&&volAccel&&strongVol&&rr>=2&&shares>=1){
        grade="A+";
        cls="aplus";
      } else if(breakout||vol>=500000){
        grade="WATCH";
        cls="watch";
      }

      rows.innerHTML+=`
        <tr class="${cls}">
          <td><a href="https://www.tradingview.com/chart/?symbol=${sym}" target="_blank">${sym}</a></td>
          <td>$${price.toFixed(2)}</td>
          <td>${(vol/1e6).toFixed(2)}M</td>
          <td>$${stop}</td>
          <td>$${target}</td>
          <td>${rr}</td>
          <td>${shares}</td>
          <td>$${dollarRisk}</td>
          <td class="tag ${grade==='A+'?'aplus':grade==='WATCH'?'watch':'no'}">${grade}</td>
        </tr>
      `;

      if(grade==="A+"&&!alerted[sym]){
        alerted[sym]=true;
        fired=true;
      }
    });

    if(!rows.children.length)
      rows.innerHTML=`<tr><td colspan="9" class="small">No qualified setups</td></tr>`;

    if(fired&&soundOn){
      beep.play().catch(()=>{});
      navigator.vibrate?.([200,100,200]);
    }

  }catch{
    rows.innerHTML=`<tr><td colspan="9" class="small">Yahoo feed unavailable</td></tr>`;
  }
}

/* ================= AUTO ================= */
scan();
setInterval(scan,15000);
</script>
