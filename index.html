<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Penny Scanner PRO v27.1</title>
<style>
body{font-family:Arial,sans-serif;background:#020617;color:white;text-align:center}
input,button{padding:10px;border-radius:8px;border:none;margin:5px}
button{background:#3b82f6;color:white;font-weight:bold}
.card{background:#0f172a;margin:10px;padding:12px;border-radius:12px;text-align:left}
.hot{border-left:5px solid #22c55e}
.warm{border-left:5px solid orange}
.watch{border-left:5px solid #38bdf8}
#leader{color:#22c55e;font-size:18px}
#progress{color:#60a5fa}
small{opacity:.7}
</style>
</head>
<body>

<h1>ğŸ“ˆ Penny Scanner PRO v27.1 (FAST)</h1>

<input id="finnhubKey" placeholder="Finnhub API Key"/>
<input id="fmpKey" placeholder="FMP API Key"/><br>
<button onclick="saveKeys()">Save Keys</button><br>

<input id="minVol" type="number" value="10000"/>
<button onclick="scan()">Scan Now</button>
<button onclick="toggleAuto()">Auto Scan</button>

<p id="session"></p>
<p id="progress"></p>
<p id="leader"></p>

<h3>ğŸ† Leaderboard</h3>
<div id="leaderboard"></div>

<h3>ğŸ“œ Signal History</h3>
<div id="history"></div>

<hr>
<div id="results"></div>

<audio id="alertSound">
<source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg">
</audio>

<script>
let FINNHUB_KEY = localStorage.getItem("FINNHUB_KEY") || "";
let FMP_KEY = localStorage.getItem("FMP_KEY") || "";
finnhubKey.value = FINNHUB_KEY;
fmpKey.value = FMP_KEY;

let autoTimer=null;
let history=[];
let leaderboard={};
let cooldown={};

const MAX_SYMBOLS=40;
const PARALLEL=5;
const TIMEOUT=5000;

function saveKeys(){
  FINNHUB_KEY=finnhubKey.value.trim();
  FMP_KEY=fmpKey.value.trim();
  localStorage.setItem("FINNHUB_KEY",FINNHUB_KEY);
  localStorage.setItem("FMP_KEY",FMP_KEY);
  alert("Keys saved");
}

function toggleAuto(){
  if(autoTimer){clearInterval(autoTimer);autoTimer=null;alert("Auto OFF")}
  else{autoTimer=setInterval(scan,60000);alert("Auto ON")}
}

function getSession(){
  const d=new Date(new Date().toLocaleString("en-US",{timeZone:"America/New_York"}));
  const t=d.getHours()*60+d.getMinutes();
  if(t>=240&&t<570) return "PRE-MARKET";
  if(t>=570&&t<960) return "OPEN";
  if(t>=960&&t<1200) return "AFTER-HOURS";
  return "CLOSED";
}

function qualityScore(dp,vol,pmh,news){
  let s=0;
  if(dp>5) s+=30; else if(dp>2) s+=15;
  if(vol>100000) s+=20;
  if(pmh) s+=25;
  if(news) s+=25;
  return s;
}

function timeoutFetch(url){
  return Promise.race([
    fetch(url).then(r=>r.json()),
    new Promise((_,rej)=>setTimeout(()=>rej("timeout"),TIMEOUT))
  ]);
}

async function scan(){
  const session=getSession();
  sessionEl.innerText="Session: "+session;
  progress.innerText="Starting scan...";
  results.innerHTML="";
  leader.innerText="";

  if(!FINNHUB_KEY||!FMP_KEY){alert("Enter API keys");return;}
  if(session==="CLOSED"){fetchNewsOnly();return;}

  let symbols=new Set();

  try{
    const g=await timeoutFetch(`https://financialmodelingprep.com/api/v3/stock_market/gainers?apikey=${FMP_KEY}`);
    const a=await timeoutFetch(`https://financialmodelingprep.com/api/v3/stock_market/actives?apikey=${FMP_KEY}`);
    g.slice(0,20).forEach(x=>symbols.add(x.symbol));
    a.slice(0,20).forEach(x=>symbols.add(x.symbol));
  }catch(e){
    progress.innerText="Feed error (FMP)";
    return;
  }

  const symList=[...symbols].slice(0,MAX_SYMBOLS);
  let completed=0;
  let best=null;
  let html="";

  for(let i=0;i<symList.length;i+=PARALLEL){
    const batch=symList.slice(i,i+PARALLEL);

    const promises=batch.map(sym=>{
      return timeoutFetch(`https://finnhub.io/api/v1/quote?symbol=${sym}&token=${FINNHUB_KEY}`)
        .then(d=>({sym,d}))
        .catch(()=>null);
    });

    const resultsBatch=await Promise.all(promises);

    resultsBatch.forEach(res=>{
      completed++;
      progress.innerText=`Scanning ${completed} / ${symList.length}...`;

      if(!res||!res.d||!res.d.c) return;

      const d=res.d;
      if(d.c>10||d.v<minVol.value) return;

      const pmh=d.dp>5;
      const score=qualityScore(d.dp,d.v,pmh,true);
      let status="WATCH";
      if(score>=70) status="HOT";
      else if(score>=50) status="WARM";

      if(status==="HOT" && !cooldown[res.sym]){
        alertSound.play();
        cooldown[res.sym]=Date.now();
      }

      leaderboard[res.sym]=Math.max(leaderboard[res.sym]||0,score);
      history.unshift(`${new Date().toLocaleTimeString()} ${res.sym} ${score}`);
      history=history.slice(0,20);

      if(!best||d.dp>best.dp) best={sym:res.sym,dp:d.dp};

      html+=`
      <div class="card ${status.toLowerCase()}">
        <b>${res.sym} $${d.c.toFixed(2)}</b><br>
        Vol:${d.v} Change:${d.dp}%<br>
        PMH:${pmh} Score:${score} Status:${status}<br>
        <a href="https://www.tradingview.com/chart/?symbol=${res.sym}" target="_blank">ğŸ“Š Chart</a>
      </div>`;
    });
  }

  if(best) leader.innerText="ğŸ”¥ Leader: "+best.sym+" ("+best.dp.toFixed(2)+"%)";
  renderHistory();
  renderLeaderboard();
  progress.innerText="Scan complete";
  results.innerHTML=html||"No penny stocks found";
}

function renderHistory(){
  historyEl.innerHTML=history.map(x=>`<div class="card watch">${x}</div>`).join("")||"No signals yet";
}
function renderLeaderboard(){
  leaderboardEl.innerHTML=Object.entries(leaderboard)
    .sort((a,b)=>b[1]-a[1]).slice(0,5)
    .map(x=>`<div class="card warm">${x[0]} â€” ${x[1]}</div>`).join("")||"No leaders yet";
}

async function fetchNewsOnly(){
  try{
    const news=await timeoutFetch(`https://finnhub.io/api/v1/news?category=general&token=${FINNHUB_KEY}`);
    results.innerHTML=news.slice(0,10).map(n=>`
      <div class="card watch">
        <b>NEWS</b><br>${n.headline}<br>
        <small>${n.source}</small><br>
        <a href="${n.url}" target="_blank">ğŸ“° Article</a>
      </div>`).join("");
    progress.innerText="News loaded";
  }catch(e){
    results.innerHTML="News feed error";
  }
}

const sessionEl=document.getElementById("session");
const results=document.getElementById("results");
const historyEl=document.getElementById("history");
const leaderboardEl=document.getElementById("leaderboard");
const leader=document.getElementById("leader");
const progress=document.getElementById("progress");
const alertSound=document.getElementById("alertSound");
</script>

</body>
</html>
