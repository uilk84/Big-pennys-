<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Penny Scanner PRO v39</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:Arial;background:#020617;color:white;text-align:center;padding:10px}
button,input,select{padding:10px;margin:5px;border-radius:8px;border:none}
button{background:#3b82f6;color:white;font-weight:bold}
.card{background:#0f172a;padding:12px;margin:10px;border-radius:12px;text-align:left}
.hot{border-left:5px solid #22c55e}
.warm{border-left:5px solid orange}
.watch{border-left:5px solid #38bdf8}
progress{width:90%;height:18px}
#progressText{color:#60a5fa}
small{opacity:.7}
.slider{width:120px}
</style>
</head>
<body>

<h2>üèÜ Penny Scanner PRO v39 (Multi-Source)</h2>

<input id="apiKey" placeholder="Finnhub API Key"><br>

<select id="pricePreset">
<option value="1">Under $1</option>
<option value="5">Under $5</option>
<option value="10" selected>Under $10</option>
</select>

<input id="minVol" type="number" value="5000"><br>

<select id="sessionFilter">
<option value="ALL">All Sessions</option>
<option value="PRE">Pre-Market</option>
<option value="OPEN">Market Open</option>
<option value="AFTER">After Hours</option>
</select><br>

<h4>Quality Score Weights</h4>
Momentum <input class="slider" type="range" min="0" max="50" id="wMomentum" value="30"><br>
Volume <input class="slider" type="range" min="0" max="50" id="wVolume" value="20"><br>
PMH Break <input class="slider" type="range" min="0" max="50" id="wPMH" value="30"><br>

<label><input type="checkbox" id="soundToggle" checked> üîî Sound Alerts</label><br>

<label>
Auto Scan every 
<input id="autoMinutes" type="number" value="3" style="width:60px"> min
<input type="checkbox" id="autoScan">
</label><br>

<button onclick="saveSettings()">Save Settings</button>
<button onclick="scan()">Scan Now</button>
<button onclick="exportCSV()">Export CSV</button>

<p id="session"></p>
<progress id="progressBar" value="0" max="100"></progress>
<p id="progressText"></p>
<p id="leader"></p>

<h3>Results</h3>
<div id="results"></div>

<h3>üèÜ Leaderboard</h3>
<div id="leaderboard"></div>

<h3>History</h3>
<div id="history"></div>

<audio id="alertSound">
<source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg">
</audio>

<script>
const MOVERS_LIST=[
"SMFL","DRCT","TWG","GNS","MULN","NKLA","TOP","JG","VVOS","PTPI",
"PBLA","SINT","CRKN","GFAI","NUWE","AGRI","CXAI","BTTR","BBAI","LUCY",
"AMC","GME","BBIG","ATER","CTRM","CEI","MCOM","XELA","IDEX","HUSA",
"SPI","KAVL","TTOO","CVNA","HKD","MEGL"
];

let history=[];
let leaderboardData={};
let cooldown={};
let autoTimer=null;
let pmhTracker={};
let resultsData=[];

apiKey.value=localStorage.getItem("APIKEY")||"";
pricePreset.value=localStorage.getItem("PRICE")||10;
minVol.value=localStorage.getItem("MINVOL")||5000;
sessionFilter.value=localStorage.getItem("SESSION")||"ALL";
soundToggle.checked = localStorage.getItem("SOUND")!=="0";
autoMinutes.value = localStorage.getItem("AUTOMIN")||3;
autoScan.checked = localStorage.getItem("AUTO")==="1";
wMomentum.value = localStorage.getItem("WMOM")||30;
wVolume.value = localStorage.getItem("WVOL")||20;
wPMH.value = localStorage.getItem("WPMH")||30;

if(autoScan.checked) startAuto();

function saveSettings(){
  localStorage.setItem("APIKEY",apiKey.value);
  localStorage.setItem("PRICE",pricePreset.value);
  localStorage.setItem("MINVOL",minVol.value);
  localStorage.setItem("SESSION",sessionFilter.value);
  localStorage.setItem("SOUND",soundToggle.checked?"1":"0");
  localStorage.setItem("AUTOMIN",autoMinutes.value);
  localStorage.setItem("AUTO",autoScan.checked?"1":"0");
  localStorage.setItem("WMOM",wMomentum.value);
  localStorage.setItem("WVOL",wVolume.value);
  localStorage.setItem("WPMH",wPMH.value);
  alert("Saved");
}

autoScan.onchange=()=>{
  if(autoScan.checked) startAuto();
  else clearInterval(autoTimer);
};

function startAuto(){
  clearInterval(autoTimer);
  autoTimer=setInterval(scan, parseInt(autoMinutes.value)*60000);
}

function dailyReset(){
  const today=new Date().toLocaleDateString("en-US");
  if(localStorage.getItem("DAY")!==today){
    localStorage.setItem("DAY",today);
    history=[];
    leaderboardData={};
    pmhTracker={};
  }
}

function getSession(){
  const d=new Date(new Date().toLocaleString("en-US",{timeZone:"America/New_York"}));
  const t=d.getHours()*60+d.getMinutes();
  if(t>=240&&t<570) return "PRE";
  if(t>=570&&t<960) return "OPEN";
  if(t>=960&&t<1200) return "AFTER";
  return "CLOSED";
}

function timeoutFetch(url,ms=4000){
  return Promise.race([
    fetch(url).then(r=>r.json()),
    new Promise((_,rej)=>setTimeout(()=>rej("timeout"),ms))
  ]);
}

function shuffle(array){
  for(let i=array.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [array[i],array[j]]=[array[j],array[i]];
  }
}

async function getSymbols(key){
  let symbols=[];

  // News symbols
  try{
    const news=await timeoutFetch(`https://finnhub.io/api/v1/news?category=general&token=${key}`);
    news.slice(0,10).forEach(n=>{
      if(n.related) symbols.push(n.related.split(",")[0]);
    });
  }catch(e){}

  // Movers list
  symbols = symbols.concat(MOVERS_LIST);

  // Remove duplicates
  symbols = [...new Set(symbols)];

  // Shuffle for rotation
  shuffle(symbols);

  return symbols.slice(0,15);
}

async function scan(){
  dailyReset();
  results.innerHTML="";
  historyEl.innerHTML="";
  leaderboardEl.innerHTML="";
  leader.innerText="";
  progressText.innerText="Starting scan...";
  progressBar.value=0;
  resultsData=[];

  const key=apiKey.value.trim();
  if(!key){alert("Enter API key");return;}

  const session=getSession();
  sessionEl.innerText="Session: "+session;

  if(sessionFilter.value!=="ALL" && sessionFilter.value!==session){
    progressText.innerText="Session filtered out";
    return;
  }

  const symbols = await getSymbols(key);

  let best=null;
  let html="";
  let done=0;

  for(const sym of symbols){
    done++;
    progressBar.value = Math.round((done/symbols.length)*100);
    progressText.innerText=`Scanning ${done}/${symbols.length}: ${sym}`;

    try{
      const q=await timeoutFetch(`https://finnhub.io/api/v1/quote?symbol=${sym}&token=${key}`);
      if(!q||!q.c) continue;
      if(q.c>pricePreset.value || q.v<minVol.value) continue;

      if(!pmhTracker[sym]) pmhTracker[sym]=q.c;
      pmhTracker[sym]=Math.max(pmhTracker[sym], q.c);
      const pmhBreak = q.c >= pmhTracker[sym];

      let breakdown=[];
      let score=0;

      if(q.dp>3){score+=parseInt(wMomentum.value); breakdown.push("Momentum");}
      if(q.v>50000){score+=parseInt(wVolume.value); breakdown.push("Volume");}
      if(pmhBreak){score+=parseInt(wPMH.value); breakdown.push("PMH Break");}

      let status="watch";
      if(score>=70) status="hot";
      else if(score>=50) status="warm";

      if(status==="hot" && !cooldown[sym]){
        if(soundToggle.checked) alertSound.play();
        cooldown[sym]=Date.now();
      }

      leaderboardData[sym] = Math.max(leaderboardData[sym]||0, score);
      history.unshift(`${new Date().toLocaleTimeString()} ${sym} Score:${score}`);
      history=history.slice(0,20);

      if(!best || q.dp>best.dp) best={sym,dp:q.dp};

      resultsData.push({sym,price:q.c,change:q.dp,vol:q.v,score});

      html+=`
      <div class="card ${status}">
        <b>${sym} $${q.c.toFixed(2)}</b><br>
        Change:${q.dp}% Vol:${q.v}<br>
        Score:${score}<br>
        <small>${breakdown.join(", ")}</small><br>
        <a href="https://www.tradingview.com/chart/?symbol=${sym}" target="_blank">üìä Chart</a>
      </div>`;
    }catch(e){}
  }

  if(best) leader.innerText="üî• Leader: "+best.sym+" ("+best.dp.toFixed(2)+"%)";

  results.innerHTML=html || "No penny stocks found";
  historyEl.innerHTML=history.map(x=>`<div class="card">${x}</div>`).join("");

  leaderboardEl.innerHTML = Object.entries(leaderboardData)
    .sort((a,b)=>b[1]-a[1]).slice(0,5)
    .map(x=>`<div class="card warm">${x[0]} ‚Äî ${x[1]}</div>`).join("");

  progressText.innerText="Scan complete";
}

function exportCSV(){
  if(resultsData.length===0){alert("No data to export");return;}
  let csv="Symbol,Price,Change,Volume,Score\n";
  resultsData.forEach(r=>{
    csv+=`${r.sym},${r.price},${r.change},${r.vol},${r.score}\n`;
  });
  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="scanner_results.csv";
  a.click();
}

const sessionEl=document.getElementById("session");
const results=document.getElementById("results");
const historyEl=document.getElementById("history");
const leader=document.getElementById("leader");
const progressText=document.getElementById("progressText");
const progressBar=document.getElementById("progressBar");
const leaderboardEl=document.getElementById("leaderboard");
</script>

</body>
</html>
