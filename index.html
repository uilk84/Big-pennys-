<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Penny Scanner PRO v27.5</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
:root{
  --bg:#020617; --card:#0f172a; --text:#fff; --accent:#3b82f6;
}
.light{
  --bg:#f3f4f6; --card:#ffffff; --text:#020617; --accent:#2563eb;
}
body{font-family:Arial,sans-serif;background:var(--bg);color:var(--text);text-align:center;margin:0;padding:10px}
input,button{padding:10px;border-radius:8px;border:none;margin:5px}
button{background:var(--accent);color:white;font-weight:bold}
.card{background:var(--card);margin:10px;padding:12px;border-radius:12px;text-align:left}
.hot{border-left:5px solid #22c55e}
.warm{border-left:5px solid orange}
.watch{border-left:5px solid #38bdf8}
#leader{color:#22c55e;font-size:18px}
#progress{color:#60a5fa}
small{opacity:.7}
.settings{background:var(--card);padding:10px;border-radius:12px;margin-bottom:10px}
</style>
</head>
<body>

<h1>ğŸ“ˆ Penny Scanner PRO v27.5</h1>

<button onclick="toggleSettings()">âš™ï¸ Settings</button>
<div id="settings" class="settings" style="display:none">

<input id="finnhubKey" placeholder="Finnhub API Key"/><br>
<button onclick="saveKey()">Save Key</button><br>

<input id="minVol" type="number" value="5000"/><br>

<label><input type="checkbox" id="autoScan"> Auto Scan</label><br>
<label><input type="checkbox" id="lightMode"> Light Mode</label><br>

</div>

<button onclick="scan()">Scan Now</button>

<p id="session"></p>
<p id="progress"></p>
<p id="leader"></p>

<h3>ğŸ† Leaderboard</h3>
<div id="leaderboard"></div>

<h3>ğŸ“œ Signal History</h3>
<div id="history"></div>

<hr>
<div id="results"></div>

<audio id="alertSound">
<source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg">
</audio>

<script>
let FINNHUB_KEY=localStorage.getItem("FINNHUB_KEY")||"";
let history=[], leaderboard={}, cooldown={}, autoTimer=null;
let batchIndex=parseInt(localStorage.getItem("batchIndex")||"0");

const TIMEOUT=5000;
const BATCHES=[
["SMFL","DRCT","TWG","GNS","MULN","NKLA","TOP","JG","VVOS","PTPI"],
["PBLA","SINT","CRKN","GFAI","NUWE","AGRI","CXAI","BTTR","BBAI","LUCY"],
["AKTS","MARA","RIOT","PLUG","SNDL","BB","SPCE","NIO","LCID","RIVN"]
];

finnhubKey.value=FINNHUB_KEY;
lightMode.checked=localStorage.getItem("LIGHT")==="1";
if(lightMode.checked) document.body.classList.add("light");

function toggleSettings(){
  settings.style.display = settings.style.display==="none"?"block":"none";
}

function saveKey(){
  FINNHUB_KEY=finnhubKey.value.trim();
  localStorage.setItem("FINNHUB_KEY",FINNHUB_KEY);
  alert("API key saved");
}

lightMode.onchange=()=>{
  if(lightMode.checked){
    document.body.classList.add("light");
    localStorage.setItem("LIGHT","1");
  }else{
    document.body.classList.remove("light");
    localStorage.removeItem("LIGHT");
  }
};

autoScan.onchange=()=>{
  if(autoScan.checked){
    autoTimer=setInterval(scan,60000);
    Notification.requestPermission();
  }else{
    clearInterval(autoTimer);
  }
};

function getSession(){
  const d=new Date(new Date().toLocaleString("en-US",{timeZone:"America/New_York"}));
  const t=d.getHours()*60+d.getMinutes();
  if(t>=240&&t<570) return "PRE-MARKET";
  if(t>=570&&t<960) return "OPEN";
  if(t>=960&&t<1200) return "AFTER-HOURS";
  return "CLOSED";
}

function dailyReset(){
  const today=new Date().toLocaleDateString("en-US",{timeZone:"America/New_York"});
  if(localStorage.getItem("DAY")!==today){
    localStorage.setItem("DAY",today);
    history=[]; leaderboard={}; cooldown={};
  }
}

function score(dp,vol,pmh){
  let s=0;
  if(dp>5)s+=30; else if(dp>2)s+=15;
  if(vol>50000)s+=20;
  if(pmh)s+=25;
  return s;
}

function timeoutFetch(url){
  return Promise.race([
    fetch(url).then(r=>r.json()),
    new Promise((_,rej)=>setTimeout(()=>rej("timeout"),TIMEOUT))
  ]);
}

async function scan(){
  dailyReset();
  const session=getSession();
  sessionEl.innerText="Session: "+session;
  progress.innerText="Starting scan...";
  results.innerHTML="";
  leader.innerText="";

  if(!FINNHUB_KEY){alert("Enter Finnhub API key");return;}

  let symbols=BATCHES[batchIndex];
  batchIndex=(batchIndex+1)%BATCHES.length;
  localStorage.setItem("batchIndex",batchIndex);

  let html="", best=null, done=0;

  for(const sym of symbols){
    try{
      progress.innerText=`Scanning ${++done}/${symbols.length}...`;
      const d=await timeoutFetch(`https://finnhub.io/api/v1/quote?symbol=${sym}&token=${FINNHUB_KEY}`);

      if(!d.c||d.c>10||d.v<minVol.value) continue;

      const pmh=d.dp>5;
      const q=score(d.dp,d.v,pmh);

      let status="WATCH";
      if(q>=70) status="HOT";
      else if(q>=50) status="WARM";

      if(status==="HOT"&&!cooldown[sym]){
        alertSound.play();
        if(Notification.permission==="granted"){
          new Notification("ğŸ”¥ HOT Stock",{
            body:`${sym} ${d.dp.toFixed(2)}%`
          });
        }
        cooldown[sym]=Date.now();
      }

      leaderboard[sym]=Math.max(leaderboard[sym]||0,q);
      history.unshift(`${new Date().toLocaleTimeString()} ${sym} Score:${q}`);
      history=history.slice(0,20);

      if(!best||d.dp>best.dp) best={sym,dp:d.dp};

      html+=`
      <div class="card ${status.toLowerCase()}">
        <b>${sym} $${d.c.toFixed(2)}</b><br>
        Vol:${d.v} Change:${d.dp}%<br>
        PMH:${pmh} Score:${q} Status:${status}<br>
        <a href="https://www.tradingview.com/chart/?symbol=${sym}" target="_blank">ğŸ“Š Chart</a>
      </div>`;
    }catch(e){}
  }

  if(best) leader.innerText="ğŸ”¥ Leader: "+best.sym+" ("+best.dp.toFixed(2)+"%)";
  renderHistory();
  renderLeaderboard();
  progress.innerText="Scan complete";
  results.innerHTML=html||"No penny stocks found in this batch";
}

function renderHistory(){
  historyEl.innerHTML=history.map(x=>`<div class="card watch">${x}</div>`).join("")||"No signals yet";
}
function renderLeaderboard(){
  leaderboardEl.innerHTML=Object.entries(leaderboard)
    .sort((a,b)=>b[1]-a[1]).slice(0,5)
    .map(x=>`<div class="card warm">${x[0]} â€” ${x[1]}</div>`).join("")||"No leaders yet";
}

const sessionEl=document.getElementById("session");
const results=document.getElementById("results");
const historyEl=document.getElementById("history");
const leaderboardEl=document.getElementById("leaderboard");
const leader=document.getElementById("leader");
const progress=document.getElementById("progress");
const alertSound=document.getElementById("alertSound");
</script>

</body>
</html>
