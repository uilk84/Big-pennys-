<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Penny Scanner v4 â€” Debug</title>
<style>
body{font-family:Arial,Helvetica,sans-serif;background:#071025;color:#e6eef8;margin:0;padding:16px}
h1{margin:0 0 12px}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
.controls input, .controls button{padding:8px;border-radius:8px;border:none;background:#0f1a2b;color:#e6eef8}
.card{background:#0b1320;padding:12px;border-radius:10px;margin-bottom:10px;border-left:6px solid #555}
.hot{border-left-color:#00ff99} .warm{border-left-color:#ffb703} .watch{border-left-color:#64b5f6}
.small{color:#9aa7bf;font-size:13px}
.debug{background:#081826;padding:10px;border-radius:8px;color:#cfe9ff;font-family:monospace;white-space:pre-wrap;max-height:220px;overflow:auto;border:1px solid rgba(255,255,255,0.03)}
.progress{height:6px;background:#132334;border-radius:6px;overflow:hidden;margin:10px 0}
.bar{height:100%;width:0;background:linear-gradient(90deg,#00e0c6,#3b82f6)}
</style>
</head>
<body>
<h1>ðŸ“ˆ Penny Scanner v4 â€” Debug</h1>

<div class="controls">
<button id="soundBtn">ðŸ”” Sound: <span id="soundState">ON</span></button>
<input id="minVol" type="number" value="100000" />
<label><input id="showAll" type="checkbox" checked /> Show All</label>
<label><input id="prOnly" type="checkbox" /> PR Only</label>
<button id="scanBtn">Scan Now</button>
</div>

<div id="status" class="small">Status: ready</div>
<div class="progress"><div id="bar" class="bar"></div></div>
<div id="leader" class="small"></div>

<div id="results"></div>

<h3 class="small">API Status / Debug</h3>
<div id="apiStatus" class="small">API Status: (not checked)</div>
<div id="rawResponse" class="debug">Raw API Response will show here (paste screenshot if it fails)</div>

<audio id="beep" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

<script>
// === CONFIG - paste your key here ===
const API_KEY = "D4yDfLr9xiMutzRAXyjDnwEOqKm5xEyQ"; // <-- put your new key here
const FMP_BASE = "https://financialmodelingprep.com/api/v3/stock_market/gainers";
const FMP_URL = FMP_BASE + "?apikey=" + API_KEY;

// === UI refs
const statusEl = document.getElementById('status');
const apiStatusEl = document.getElementById('apiStatus');
const rawEl = document.getElementById('rawResponse');
const resultsEl = document.getElementById('results');
const leaderEl = document.getElementById('leader');
const bar = document.getElementById('bar');
const beep = document.getElementById('beep');

let sound=true;
document.getElementById('soundBtn').onclick = ()=>{
  sound = !sound;
  document.getElementById('soundState').innerText = sound ? 'ON':'OFF';
};
document.getElementById('scanBtn').onclick = ()=> scanNow();

let progress=0;
function animateProgress(){
  progress = Math.min(100, progress + 6);
  bar.style.width = progress + "%";
  if(progress < 100) setTimeout(animateProgress, 160);
}

async function scanNow(){
  progress = 0; bar.style.width='0%';
  animateProgress();
  statusEl.textContent = "Status: scanning...";
  try {
    // add cache-bust param
    const url = FMP_URL + "&t=" + Date.now();
    const res = await fetch(url, {cache:'no-store'});
    const text = await res.text();
    apiStatusEl.textContent = `API Status: HTTP ${res.status} ${res.statusText}`;
    rawEl.textContent = text.slice(0,2000);
    // if not OK, fallback to demo
    if(!res.ok) {
      statusEl.textContent = "Status: API failed â€” using DEMO";
      renderDemo();
      return;
    }
    // parse JSON
    let json;
    try { json = JSON.parse(text); } catch(e) {
      statusEl.textContent = "Status: JSON parse failed â€” using DEMO";
      renderDemo();
      return;
    }
    // Good data -> render
    statusEl.textContent = "Status: LIVE feed OK";
    renderList(json, "FMP live");
  } catch(err){
    apiStatusEl.textContent = `API Error: ${err.message||err}`;
    rawEl.textContent = String(err.stack || err.message || err);
    statusEl.textContent = "Status: fetch error â€” using DEMO";
    renderDemo();
  }
}

function renderDemo(){
  const demo = [
    {symbol:"SMOVE", price:3.42, volume:800000, name:"SMOVE surges after press release"},
    {symbol:"TWG", price:5.11, volume:1200000, name:"TWG launches new product"},
    {symbol:"DRCT", price:2.95, volume:450000, name:"DRCT heavy volume after announcement"},
    {symbol:"TRUE", price:1.88, volume:250000, name:"TRUE reports earnings"}
  ];
  renderList(demo, "Demo");
  apiStatusEl.textContent += " | demo active";
}

function renderList(items, source){
  resultsEl.innerHTML = "";
  const minVol = Number(document.getElementById('minVol').value || 0);
  const prOnly = document.getElementById('prOnly').checked;
  const showAll = document.getElementById('showAll').checked;
  const filtered = (items || []).filter(s => (s.volume || s.volume === 0 ? s.volume : (s.volume || s.v || 0)) >= minVol);

  const display = showAll ? filtered : filtered.slice(0,10);
  if(display.length === 0) {
    resultsEl.innerHTML = '<div class="small">No stocks match filters</div>';
    leaderEl.textContent = "Leader: none";
    return;
  }
  leaderEl.textContent = "Leader: " + (display[0].symbol || display[0].ticker || 'N/A');

  display.forEach((s, i) => {
    const sym = s.symbol || s.ticker || s.code || '';
    const price = s.price || s.currentPrice || s.last || 0;
    const vol = s.volume || s.v || 0;
    const title = s.name || s.companyName || s.title || '';
    let cls='watch';
    if(vol > 700000) cls='hot';
    else if(vol > 400000) cls='warm';
    const card = document.createElement('div');
    card.className = 'card ' + cls;
    card.innerHTML = `<div style="font-weight:700">${sym} $${Number(price).toFixed(2)}</div>
                      <div class="small">Vol: ${Number(vol).toLocaleString()}</div>
                      <div class="small">${title}</div>
                      <div style="margin-top:8px;font-weight:700">${cls.toUpperCase()}</div>
                      <div style="margin-top:6px"><a href="https://finance.yahoo.com/quote/${sym}" target="_blank" style="color:#8ed1ff">Chart</a></div>`;
    resultsEl.appendChild(card);
    if(cls === 'hot' && sound) { try{ beep.play(); navigator.vibrate?.(100); }catch(e){} }
  });
}

// initial
scanNow();
setInterval(scanNow, 30000);

</script>
</body>
</html>
