<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Penny Scanner PRO v32.1</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:Arial;background:#020617;color:white;text-align:center;padding:10px}
button,input,select{padding:10px;margin:5px;border-radius:8px;border:none}
button{background:#3b82f6;color:white;font-weight:bold}
.card{background:#0f172a;padding:12px;margin:10px;border-radius:12px;text-align:left}
.hot{border-left:5px solid #22c55e}
.warm{border-left:5px solid orange}
.watch{border-left:5px solid #38bdf8}
#progress{color:#60a5fa}
iframe{width:100%;height:200px;border:none;border-radius:10px;margin-top:5px}
</style>
</head>
<body>

<h2>üìà Penny Scanner PRO v32.1 (Stable)</h2>

<input id="apiKey" placeholder="Finnhub API Key"><br>

<select id="pricePreset">
<option value="1">Under $1</option>
<option value="5">Under $5</option>
<option value="10" selected>Under $10</option>
</select>

<input id="minVol" type="number" value="5000">

<br>
<button onclick="saveSettings()">Save Settings</button>
<button onclick="scan()">Scan Now</button>

<p id="session"></p>
<p id="progress"></p>
<p id="leader"></p>

<h3>Results</h3>
<div id="results"></div>

<h3>History</h3>
<div id="history"></div>

<audio id="alertSound">
<source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg">
</audio>

<script>
let history=[];
let cooldown={};

apiKey.value=localStorage.getItem("APIKEY")||"";
pricePreset.value=localStorage.getItem("PRICE")||10;
minVol.value=localStorage.getItem("MINVOL")||5000;

const TIMEOUT=5000;
const PARALLEL=5;

function saveSettings(){
  localStorage.setItem("APIKEY",apiKey.value);
  localStorage.setItem("PRICE",pricePreset.value);
  localStorage.setItem("MINVOL",minVol.value);
  alert("Saved");
}

function getSession(){
  const d=new Date(new Date().toLocaleString("en-US",{timeZone:"America/New_York"}));
  const t=d.getHours()*60+d.getMinutes();
  if(t>=240&&t<570) return "PRE";
  if(t>=570&&t<960) return "OPEN";
  if(t>=960&&t<1200) return "AFTER";
  return "CLOSED";
}

function timeoutFetch(url){
  return Promise.race([
    fetch(url).then(r=>r.json()),
    new Promise((_,rej)=>setTimeout(()=>rej("timeout"),TIMEOUT))
  ]);
}

function calcRSI(arr){
  let gains=0,losses=0;
  for(let i=1;i<arr.length;i++){
    let d=arr[i]-arr[i-1];
    if(d>0) gains+=d; else losses-=d;
  }
  let rs=gains/(losses||1);
  return 100-(100/(1+rs));
}

async function scan(){
  results.innerHTML="";
  leader.innerText="";
  progress.innerText="Scanning...";
  historyEl.innerHTML="";

  const key=apiKey.value.trim();
  if(!key){alert("Enter API key");return;}

  Notification.requestPermission();

  const session=getSession();
  sessionEl.innerText="Session: "+session;

  // 1Ô∏è‚É£ Pull symbols from Finnhub news
  let symbols=new Set();
  let news;
  try{
    news = await timeoutFetch(`https://finnhub.io/api/v1/news?category=general&token=${key}`);
  }catch(e){
    progress.innerText="News feed failed";
    return;
  }

  news.slice(0,15).forEach(n=>{
    if(n.related){
      symbols.add(n.related.split(",")[0]);
    }
  });

  const list=[...symbols];
  let done=0;
  let best=null;
  let html="";

  // 2Ô∏è‚É£ Scan in parallel batches
  for(let i=0;i<list.length;i+=PARALLEL){
    const batch=list.slice(i,i+PARALLEL);

    const promises=batch.map(sym=>{
      return timeoutFetch(`https://finnhub.io/api/v1/quote?symbol=${sym}&token=${key}`)
        .then(q=>({sym,q}))
        .catch(()=>null);
    });

    const resultsBatch=await Promise.all(promises);

    for(const res of resultsBatch){
      done++;
      progress.innerText=`Scanning ${done}/${list.length}`;

      if(!res || !res.q || !res.q.c) continue;

      const q=res.q;
      if(q.c>pricePreset.value || q.v<minVol.value) continue;

      let rsi=50;
      try{
        const c=await timeoutFetch(`https://finnhub.io/api/v1/stock/candle?symbol=${res.sym}&resolution=5&count=14&token=${key}`);
        rsi = c.c ? calcRSI(c.c) : 50;
      }catch(e){}

      const pmh=q.dp>5;

      let score=0;
      if(q.dp>3) score+=30;
      if(q.v>50000) score+=20;
      if(pmh) score+=30;
      if(rsi>60 && rsi<80) score+=20;

      let status="watch";
      if(score>=70) status="hot";
      else if(score>=50) status="warm";

      if(status==="hot" && !cooldown[res.sym]){
        alertSound.play();
        if(Notification.permission==="granted"){
          new Notification("üî• HOT",{body:`${res.sym} ${q.dp.toFixed(2)}%`});
        }
        cooldown[res.sym]=Date.now();
      }

      history.unshift(`${new Date().toLocaleTimeString()} ${res.sym} Score:${score}`);
      history=history.slice(0,20);

      if(!best || q.dp>best.dp) best={sym:res.sym,dp:q.dp};

      html+=`
      <div class="card ${status}">
        <b>${res.sym} $${q.c.toFixed(2)}</b><br>
        Change:${q.dp}% Vol:${q.v}<br>
        RSI:${rsi.toFixed(1)} PMH:${pmh}<br>
        Score:${score}<br>
        <iframe src="https://s.tradingview.com/widgetembed/?symbol=${res.sym}&interval=5&theme=dark"></iframe>
      </div>`;
    }
  }

  if(best) leader.innerText="üî• Leader: "+best.sym+" ("+best.dp.toFixed(2)+"%)";
  historyEl.innerHTML=history.map(x=>`<div class="card">${x}</div>`).join("");
  results.innerHTML=html || "No penny stocks found";
  progress.innerText="Scan complete";
}

const sessionEl=document.getElementById("session");
const results=document.getElementById("results");
const historyEl=document.getElementById("history");
const leader=document.getElementById("leader");
const progress=document.getElementById("progress");
</script>

</body>
</html>
