<!doctype html>
<html>
<head>
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>PennyS Scanner</title>

<style>
body{
  background:#0f172a;
  color:#e5e7eb;
  font-family:sans-serif;
  padding:12px;
}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
}
th,td{
  padding:8px;
  border-bottom:1px solid #334155;
  text-align:left;
}
.badgeA{color:#22c55e;font-weight:bold}
.badgeW{color:#facc15;font-weight:bold}
button,input{
  padding:6px;
  margin:4px;
}
</style>
</head>

<body>

<h2>PennyS Scanner</h2>

<button onclick="unlockAudio()">ðŸ”” Enable Sound Alerts</button>

<label>
  <input type="checkbox" id="pm"> Premarket
</label>

<table>
<thead>
<tr>
  <th>Sym</th>
  <th>Price</th>
  <th>Score</th>
  <th>Vol</th>
  <th>Type</th>
</tr>
</thead>
<tbody id="rows">
<tr><td colspan="5">Loadingâ€¦</td></tr>
</tbody>
</table>

<h3>Set Alert</h3>
<input id="asym" placeholder="Symbol">
<input id="abreak" placeholder="Breakout">
<input id="ainv" placeholder="Invalidation">
<button onclick="addAlert(asym.value,abreak.value,ainv.value)">Save Alert</button>

<script src="app.js"></script>

<script>
/* ---------- PREMARKET TOGGLE ---------- */
pm.checked = localStorage.getItem('premarket') === 'on';
pm.onchange = ()=>{
  localStorage.setItem('premarket', pm.checked ? 'on' : 'off');
  location.reload();
};

/* ---------- DATE LOGIC (CRITICAL FIX) ---------- */
function getPolygonDate(){
  const now = new Date();
  const et = new Date(
    now.toLocaleString("en-US", { timeZone: "America/New_York" })
  );

  const marketOpen =
    et.getHours() > 9 ||
    (et.getHours() === 9 && et.getMinutes() >= 30);

  const d = new Date(et);
  if(!marketOpen){
    d.setDate(d.getDate() - 1); // premarket â†’ yesterday
  }

  return d.toISOString().split('T')[0];
}

/* ---------- MAIN LOAD ---------- */
async function load(){
  if(!inTradeWindow()){
    rows.innerHTML =
      '<tr><td colspan="5">Outside trade window</td></tr>';
    return;
  }

  const dateStr = getPolygonDate();

  try{
    const r = await fetch(
      `https://api.polygon.io/v2/aggs/grouped/locale/us/market/stocks/${dateStr}?adjusted=true&apiKey=${API_KEY}`
    );
    const d = await r.json();

    if(!d.results || !d.results.length){
      rows.innerHTML =
        '<tr><td colspan="5">No movers right now</td></tr>';
      return;
    }

    const stocks = d.results
      .filter(x =>
        x.c >= 0.3 &&
        x.c <= 5 &&
        ((x.c - x.o) / x.o) * 100 >= 2
      )
      .map(x=>{
        const o = {
          sym: x.T,
          p: x.c,
          c: ((x.c - x.o) / x.o) * 100,
          v: x.v,
          hod: x.h,
          vs: x.v / 250000
        };
        o.score = score(o);
        return o;
      })
      .filter(x => x.v >= 250000 && x.score >= 55)
      .sort((a,b)=>b.score-a.score)
      .slice(0,20);

    rows.innerHTML = stocks.length
      ? stocks.map(x=>`
          <tr>
            <td><b>${x.sym}</b></td>
            <td>$${x.p.toFixed(2)}</td>
            <td>${x.score}</td>
            <td>${fmt(x.v)}</td>
            <td class="${x.score>=70?'badgeA':'badgeW'}">
              ${x.score>=70?'A+':'WATCH'}
            </td>
          </tr>
        `).join('')
      : '<tr><td colspan="5">No movers right now</td></tr>';

    checkAlerts(stocks);

  }catch(e){
    rows.innerHTML =
      '<tr><td colspan="5">Data error</td></tr>';
  }
}

load();
setInterval(load, 60000); // grouped data updates ~1 min
</script>

</body>
</html>
