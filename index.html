<script>
/* ================= STATE ================= */
const rows = document.getElementById("rows");
const beep = document.getElementById("beep");
const soundBtn = document.getElementById("soundBtn");
const sessionLabel = document.getElementById("sessionLabel");

let soundOn = true;
let hod = {};
let lastVol = {};
let base = {};
let alerted = {};

/* ================= SOUND ================= */
soundBtn.onclick = () => {
  soundOn = !soundOn;
  soundBtn.innerText = soundOn ? "ðŸ”” Sound: ON" : "ðŸ”• Sound: OFF";
};

/* ================= PRESETS ================= */
function setPreset(type){
  const minP = document.getElementById("minPrice");
  const maxP = document.getElementById("maxPrice");

  if(type === "lotto"){
    minP.value = 0.10;
    maxP.value = 1.00;
  }
  if(type === "scalp"){
    minP.value = 0.30;
    maxP.value = 3.00;
  }
  if(type === "momentum"){
    minP.value = 1.00;
    maxP.value = 10.00;
  }
  scan(); // immediate refresh
}

/* ================= SESSION ================= */
function currentSession(){
  const d = new Date(
    new Date().toLocaleString("en-US", { timeZone: "America/New_York" })
  );
  const h = d.getHours() + d.getMinutes() / 60;

  if(h >= 4 && h < 9.5) return "PRE";
  if(h >= 9.5 && h < 16) return "MARKET";
  if(h >= 16 && h <= 20) return "POST";
  return "CLOSED";
}

function sessionAllowed(){
  const s = currentSession();
  if(s === "PRE") return document.getElementById("pre").checked;
  if(s === "MARKET") return true;
  if(s === "POST") return document.getElementById("post").checked;
  return false;
}

/* ================= SCAN ================= */
async function scan(){
  const session = currentSession();
  sessionLabel.innerText = session;

  if(!sessionAllowed()){
    rows.innerHTML = `
      <tr><td colspan="7" class="small">
        Session mismatch â€” ${session} (toggle required)
      </td></tr>`;
    return;
  }

  const minPrice = parseFloat(document.getElementById("minPrice").value) || 0;
  const maxPrice = parseFloat(document.getElementById("maxPrice").value) || Infinity;

  try {
    const res = await fetch(
      "https://corsproxy.io/?https://query1.finance.yahoo.com/v1/finance/screener/predefined/saved?count=50&scrIds=day_gainers"
    );
    const data = await res.json();
    const list = data?.finance?.result?.[0]?.quotes || [];

    rows.innerHTML = "";
    let fired = false;

    list.forEach(t => {
      const sym = t.symbol;
      const price = t.regularMarketPrice;
      const vol = t.regularMarketVolume || 0;

      if(!sym || !price) return;
      if(price < minPrice || price > maxPrice) return;

      const prevH = hod[sym] || 0;
      const prevV = lastVol[sym] || 0;

      hod[sym] = Math.max(prevH, price);
      lastVol[sym] = vol;

      if(!base[sym]) base[sym] = price;
      if(price > prevH) base[sym] = prevH || price;

      const breakout = price > prevH;
      const volAccel = vol > prevV * 1.25;
      const strongVol = vol >= 1500000;

      const stop = +(base[sym] * 0.97).toFixed(2);
      const risk = price - stop;
      const target = +(price + risk * 2).toFixed(2);
      const rr = risk > 0 ? +( (target - price) / risk ).toFixed(2) : 0;

      let grade = "NO";
      let cls = "notrade";

      if(breakout && volAccel && strongVol && rr >= 2){
        grade = "A+";
        cls = "aplus";
      } else if(breakout || vol >= 500000){
        grade = "WATCH";
        cls = "watch";
      }

      const tr = document.createElement("tr");
      tr.className = cls;

      tr.innerHTML = `
        <td>
          <a href="https://www.tradingview.com/chart/?symbol=${sym}" target="_blank">
            ${sym}
          </a>
        </td>
        <td>$${price.toFixed(2)}</td>
        <td>${(vol / 1e6).toFixed(2)}M</td>
        <td>$${stop}</td>
        <td>$${target}</td>
        <td class="${rr >= 2 ? 'goodrr' : 'badrr'}">${rr}</td>
        <td class="tag ${grade === 'A+' ? 'aplus' : grade === 'WATCH' ? 'watch' : 'no'}">
          ${grade}
        </td>
      `;
      rows.appendChild(tr);

      if(grade === "A+" && !alerted[sym]){
        alerted[sym] = true;
        fired = true;
      }
    });

    if(!rows.children.length){
      rows.innerHTML =
        `<tr><td colspan="7" class="small">No qualified setups</td></tr>`;
    }

    if(fired && soundOn){
      beep.play().catch(()=>{});
      navigator.vibrate?.([200,100,200]);
    }

  } catch (e) {
    rows.innerHTML =
      `<tr><td colspan="7" class="small">Yahoo feed unavailable</td></tr>`;
  }
}

/* ================= AUTO ================= */
scan();
setInterval(scan, 15000);
</script>
