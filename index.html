<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Penny Scanner PRO v35</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:Arial;background:#020617;color:white;text-align:center;padding:10px}
button,input,select{padding:10px;margin:5px;border-radius:8px;border:none}
button{background:#3b82f6;color:white;font-weight:bold}
.card{background:#0f172a;padding:12px;margin:10px;border-radius:12px;text-align:left}
.hot{border-left:5px solid #22c55e}
.warm{border-left:5px solid orange}
.watch{border-left:5px solid #38bdf8}
.volHigh{color:#f87171}
.volMed{color:#fb923c}
.volLow{color:#60a5fa}
#progressText{color:#60a5fa}
progress{width:90%;height:18px}
.toggle{font-size:14px}
small{opacity:.7}
</style>
</head>
<body>

<h2>üìà Penny Scanner PRO v35</h2>

<input id="apiKey" placeholder="Finnhub API Key"><br>

<select id="pricePreset">
<option value="1">Under $1</option>
<option value="5">Under $5</option>
<option value="10" selected>Under $10</option>
</select>

<input id="minVol" type="number" value="5000"><br>

<select id="feedMode">
<option value="news">üì∞ News Catalysts</option>
<option value="gainers">üìà Movers / Gainers</option>
</select><br>

<label class="toggle">
<input type="checkbox" id="autoScan"> ‚è± Auto Scan (1 min)
</label><br>

<label class="toggle">
<input type="checkbox" id="soundToggle" checked> üîî Sound Alerts
</label><br>

<button onclick="saveSettings()">Save Settings</button>
<button onclick="scan()">Scan Now</button>

<p id="session"></p>
<progress id="progressBar" value="0" max="100"></progress>
<p id="progressText"></p>
<p id="leader"></p>

<h3>Results</h3>
<div id="results"></div>

<h3>History</h3>
<div id="history"></div>

<audio id="alertSound">
<source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg">
</audio>

<script>
const FALLBACK_SYMBOLS=[
"SMFL","DRCT","TWG","GNS","MULN","NKLA","TOP","JG","VVOS","PTPI",
"PBLA","SINT","CRKN","GFAI","NUWE","AGRI","CXAI","BTTR","BBAI","LUCY",
"AMC","GME","BBIG","ATER","CTRM","CEI","MCOM","XELA","IDEX"
];

let history=[];
let cooldown={};
let autoTimer=null;

apiKey.value=localStorage.getItem("APIKEY")||"";
pricePreset.value=localStorage.getItem("PRICE")||10;
minVol.value=localStorage.getItem("MINVOL")||5000;
soundToggle.checked = localStorage.getItem("SOUND")!=="0";
feedMode.value = localStorage.getItem("FEED")||"news";
autoScan.checked = localStorage.getItem("AUTO")==="1";

if(autoScan.checked) startAuto();

function saveSettings(){
  localStorage.setItem("APIKEY",apiKey.value);
  localStorage.setItem("PRICE",pricePreset.value);
  localStorage.setItem("MINVOL",minVol.value);
  localStorage.setItem("SOUND",soundToggle.checked?"1":"0");
  localStorage.setItem("FEED",feedMode.value);
  localStorage.setItem("AUTO",autoScan.checked?"1":"0");
  alert("Saved");
}

autoScan.onchange=()=>{
  if(autoScan.checked) startAuto();
  else clearInterval(autoTimer);
};

function startAuto(){
  autoTimer=setInterval(scan,60000);
}

function dailyReset(){
  const today=new Date().toLocaleDateString("en-US");
  if(localStorage.getItem("DAY")!==today){
    localStorage.setItem("DAY",today);
    history=[];
  }
}

function getSession(){
  const d=new Date(new Date().toLocaleString("en-US",{timeZone:"America/New_York"}));
  const t=d.getHours()*60+d.getMinutes();
  if(t>=240&&t<570) return "PRE-MARKET";
  if(t>=570&&t<960) return "OPEN";
  if(t>=960&&t<1200) return "AFTER-HOURS";
  return "CLOSED";
}

function timeoutFetch(url,ms=4000){
  return Promise.race([
    fetch(url).then(r=>r.json()),
    new Promise((_,rej)=>setTimeout(()=>rej("timeout"),ms))
  ]);
}

function calcRSI(arr){
  if(!arr||arr.length<2) return 50;
  let gains=0,losses=0;
  for(let i=1;i<arr.length;i++){
    let d=arr[i]-arr[i-1];
    if(d>0) gains+=d; else losses-=d;
  }
  let rs=gains/(losses||1);
  return 100-(100/(1+rs));
}

function volumeClass(v){
  if(v>200000) return "volHigh";
  if(v>50000) return "volMed";
  return "volLow";
}

async function getSymbols(key){
  let symbols=[];
  if(feedMode.value==="news"){
    try{
      const news=await timeoutFetch(`https://finnhub.io/api/v1/news?category=general&token=${key}`);
      news.slice(0,15).forEach(n=>{
        if(n.related) symbols.push(n.related.split(",")[0]);
      });
    }catch(e){}
  }
  if(symbols.length===0){
    symbols=[...FALLBACK_SYMBOLS];
  }
  return symbols;
}

async function scan(){
  dailyReset();
  results.innerHTML="";
  leader.innerText="";
  historyEl.innerHTML="";
  progressText.innerText="Starting scan...";
  progressBar.value=0;

  const key=apiKey.value.trim();
  if(!key){alert("Enter API key");return;}

  Notification.requestPermission();

  const session=getSession();
  sessionEl.innerText="Session: "+session;

  const symbols=await getSymbols(key);

  let best=null;
  let html="";
  let done=0;

  for(const sym of symbols){
    done++;
    progressBar.value = Math.round((done/symbols.length)*100);
    progressText.innerText=`Scanning ${done}/${symbols.length}: ${sym}`;

    try{
      const q=await timeoutFetch(`https://finnhub.io/api/v1/quote?symbol=${sym}&token=${key}`);
      if(!q||!q.c) continue;
      if(q.c>pricePreset.value || q.v<minVol.value) continue;

      let rsi=50;
      try{
        const c=await timeoutFetch(`https://finnhub.io/api/v1/stock/candle?symbol=${sym}&resolution=5&count=14&token=${key}`);
        rsi=calcRSI(c.c);
      }catch(e){}

      const pmh=q.dp>5;

      let breakdown=[];
      let score=0;
      if(q.dp>3){score+=30; breakdown.push("Momentum");}
      if(q.v>50000){score+=20; breakdown.push("Volume");}
      if(pmh){score+=30; breakdown.push("PMH");}
      if(rsi>60&&rsi<80){score+=20; breakdown.push("RSI");}

      let status="watch";
      if(score>=70) status="hot";
      else if(score>=50) status="warm";

      if(status==="hot" && !cooldown[sym]){
        if(soundToggle.checked){
          alertSound.play();
        }
        if(Notification.permission==="granted"){
          new Notification("üî• HOT STOCK",{body:`${sym} ${q.dp.toFixed(2)}%`});
        }
        cooldown[sym]=Date.now();
      }

      history.unshift(`${new Date().toLocaleTimeString()} ${sym} Score:${score}`);
      history=history.slice(0,20);

      if(!best || q.dp>best.dp) best={sym,dp:q.dp};

      html+=`
      <div class="card ${status}">
        <b>${sym} $${q.c.toFixed(2)}</b><br>
        Change:${q.dp}% 
        <span class="${volumeClass(q.v)}">Vol:${q.v}</span><br>
        RSI:${rsi.toFixed(1)} PMH:${pmh}<br>
        Score:${score}<br>
        <small>${breakdown.join(", ")}</small><br>
        <a href="https://www.tradingview.com/chart/?symbol=${sym}" target="_blank">üìä Chart</a>
      </div>`;
    }catch(e){}
  }

  if(best) leader.innerText="üî• Leader: "+best.sym+" ("+best.dp.toFixed(2)+"%)";
  results.innerHTML=html || "No penny stocks found";
  historyEl.innerHTML=history.map(x=>`<div class="card">${x}</div>`).join("");
  progressText.innerText="Scan complete";
}

const sessionEl=document.getElementById("session");
const results=document.getElementById("results");
const historyEl=document.getElementById("history");
const leader=document.getElementById("leader");
const progressText=document.getElementById("progressText");
const progressBar=document.getElementById("progressBar");
</script>

</body>
</html>
