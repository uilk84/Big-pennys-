<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Penny Scanner PRO v17</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
:root{--bg:#050b16;--card:#0f1b2d;--text:white;}
.light{--bg:#f4f4f4;--card:#ffffff;--text:black;}
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:var(--bg);color:var(--text);text-align:center;}
h1{margin-top:10px;}
input,button{padding:10px;border-radius:8px;border:none;font-size:15px;}
button{background:#2f80ff;color:white;}
.card{background:var(--card);margin:12px;padding:12px;border-radius:12px;text-align:left;}
.hot{border-left:5px solid #00ff9c;}
.warm{border-left:5px solid orange;}
.watch{border-left:5px solid #5bc0ff;}
.star{float:right;font-size:20px;cursor:pointer;}
.status{color:#7fd3ff;margin:4px;}
a{color:#4db7ff;}
</style>
</head>
<body>

<h1>üìà Penny Scanner PRO v17</h1>

<input id="apiKey" placeholder="Finnhub API Key">
<button onclick="saveKey()">Save</button>

<br><br>

<input id="telegram" placeholder="Telegram Webhook (optional)">
<button onclick="saveTelegram()">Save Telegram</button>

<br><br>

<input id="minVol" value="200000">
<button onclick="scan()">Scan Now</button>

<div>
<label><input type="checkbox" id="prOnly"> PR Only</label>
<label><input type="checkbox" id="gainersOnly"> Top Gainers</label>
<label><input type="checkbox" id="themeToggle" onchange="toggleTheme()"> Light Mode</label>
</div>

<div class="status" id="session"></div>
<div class="status" id="status"></div>
<div class="status" id="leader"></div>

<h3>‚≠ê Favorites</h3>
<div id="favorites"></div>

<hr>
<div id="results"></div>

<audio id="alertSound">
<source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg">
</audio>

<script>
const KEY_STORE="FINNHUB_KEY_V17";
const FAV_STORE="FAVS_V17";
const TG_STORE="TG_WEBHOOK";
let autoTimer=null;

function saveKey(){
  const k=apiKey.value.trim();
  if(!k) return alert("Paste API key");
  localStorage.setItem(KEY_STORE,k);
  alert("Saved");
}
function saveTelegram(){
  localStorage.setItem(TG_STORE,telegram.value.trim());
  alert("Telegram saved");
}
function getKey(){return localStorage.getItem(KEY_STORE);}
function getFavs(){return JSON.parse(localStorage.getItem(FAV_STORE)||"[]");}
function saveFavs(f){localStorage.setItem(FAV_STORE,JSON.stringify(f));renderFavs();}
function toggleTheme(){document.body.classList.toggle("light");}

function getSession(){
  const now=new Date().toLocaleString("en-US",{timeZone:"America/New_York"});
  const d=new Date(now);const t=d.getHours()*60+d.getMinutes();
  if(t>=240&&t<570) return "PRE-MARKET";
  if(t>=570&&t<=960) return "OPEN";
  if(t>960&&t<=1200) return "AFTER-HOURS";
  return "CLOSED";
}

function qualityScore(vol,pct,pmhBreak){
  let score=0;
  if(vol>1000000) score+=40;
  else if(vol>500000) score+=25;
  if(pct>5) score+=25;
  else if(pct>2) score+=15;
  if(pmhBreak) score+=20;
  return score;
}

function tradePlan(price){
  const entry=price;
  const stop=(price*0.95).toFixed(2);
  const target=(price*1.10).toFixed(2);
  const rr=((target-entry)/(entry-stop)).toFixed(2);
  return {entry,stop,target,rr};
}

function renderFavs(){
  favorites.innerHTML="";
  getFavs().forEach(s=>{
    favorites.innerHTML+=`<div class="card watch">‚≠ê ${s}</div>`;
  });
}

function toggleFav(sym){
  let f=getFavs();
  if(f.includes(sym)) f=f.filter(x=>x!==sym);
  else f.push(sym);
  saveFavs(f);
  scan();
}

async function telegramAlert(msg){
  const url=localStorage.getItem(TG_STORE);
  if(!url) return;
  fetch(url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:msg})});
}

async function scan(){
  const key=getKey(); if(!key) return alert("Save API key");
  const minVol=parseInt(minVol.value)||0;
  const prOnly=prOnlyBox.checked;
  const gainersOnly=gainersOnlyBox.checked;

  session.innerText="Session: "+getSession()+" | Auto 60s";
  status.innerText="Scanning feeds...";
  results.innerHTML="";
  leader.innerText="";

  const feeds=[
    `https://finnhub.io/api/v1/news?category=general&token=${key}`,
    `https://finnhub.io/api/v1/news?category=forex&token=${key}`
  ];

  let leaderPick=null;
  let hotAlerted=false;

  for(const feed of feeds){
    const news=await (await fetch(feed)).json();

    for(let item of news.slice(0,15)){
      if(prOnly && !item.headline.toLowerCase().includes("announce")) continue;
      const sym=(item.related||"").split(",")[0];
      if(!sym) continue;

      const q=await (await fetch(`https://finnhub.io/api/v1/quote?symbol=${sym}&token=${key}`)).json();

      const to=Math.floor(Date.now()/1000);
      const from=to-3600;
      const candle=await (await fetch(`https://finnhub.io/api/v1/stock/candle?symbol=${sym}&resolution=1&from=${from}&to=${to}&token=${key}`)).json();

      if(candle.s!=="ok") continue;
      const v=candle.v;
      if(v.length<2) continue;

      const vol=v[v.length-1];
      const prev=v[v.length-2];
      const pmh=Math.max(...candle.h);
      const pmhBreak=q.c>pmh;

      if(vol<minVol) continue;

      const pct=((q.c-q.pc)/q.pc*100)||0;
      if(gainersOnly && pct<2) continue;

      const score=qualityScore(vol,pct,pmhBreak);
      const statusType=score>70?"HOT":score>40?"WARM":"WATCH";

      if(!leaderPick||score>leaderPick.score) leaderPick={symbol:sym,score};

      if(statusType==="HOT" && !hotAlerted){
        alertSound.play();
        alert("HOT STOCK: "+sym);
        telegramAlert("üî• HOT STOCK: "+sym+" Score:"+score);
        hotAlerted=true;
      }

      const plan=tradePlan(q.c);
      const favs=getFavs();
      const star=favs.includes(sym)?"‚≠ê":"‚òÜ";

      const card=document.createElement("div");
      card.className="card "+(statusType==="HOT"?"hot":statusType==="WARM"?"warm":"watch");
      card.innerHTML=`
        <span class="star" onclick="toggleFav('${sym}')">${star}</span>
        <h3>${sym} $${q.c.toFixed(2)}</h3>
        <p>${item.headline}</p>
        <p>Vol: ${vol.toLocaleString()} | ${pct.toFixed(2)}% | PMH Break: ${pmhBreak}</p>
        <p>Quality Score: ${score}</p>
        <p>üéØ Entry: ${plan.entry.toFixed(2)} | Stop: ${plan.stop} | Target: ${plan.target} | R:R ${plan.rr}</p>
      `;
      results.appendChild(card);
    }
  }

  status.innerText="Scan complete";
  if(leaderPick) leader.innerText="üî• Leader: "+leaderPick.symbol+" (Score "+leaderPick.score+")";

  if(autoTimer) clearInterval(autoTimer);
  autoTimer=setInterval(scan,60000);
}

apiKey.value=getKey()||"";
telegram.value=localStorage.getItem(TG_STORE)||"";
session.innerText="Session: "+getSession();
renderFavs();
</script>

</body>
</html>
