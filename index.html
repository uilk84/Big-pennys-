<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Penny Scanner PRO v40.2</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:Arial;background:#020617;color:white;text-align:center;padding:10px}
button,input,select{padding:8px;margin:4px;border-radius:8px;border:none}
button{background:#3b82f6;color:white;font-weight:bold}
.card{background:#0f172a;padding:12px;margin:10px;border-radius:12px;text-align:left}
.hot{border-left:5px solid #22c55e}
.warm{border-left:5px solid orange}
.watch{border-left:5px solid #38bdf8}
progress{width:90%;height:16px}
#progressText{color:#60a5fa}
.tab{background:#1e293b;margin:5px;padding:8px;border-radius:8px;display:inline-block}
.tab.active{background:#3b82f6}
.hidden{display:none}
small{opacity:.8}
.slider{width:120px}
</style>
</head>
<body>

<h2>üèÜ Penny Scanner PRO v40.2 (Always Finds Stocks)</h2>

<input id="apiKey" placeholder="Finnhub API Key"><br>

<select id="pricePreset">
<option value="1">Under $1</option>
<option value="5">Under $5</option>
<option value="10" selected>Under $10</option>
</select>

<input id="minVol" type="number" value="1000"><br>

<select id="sessionFilter">
<option value="ALL">All Sessions</option>
<option value="PRE">Pre-Market</option>
<option value="OPEN">Market Open</option>
<option value="AFTER">After Hours</option>
</select><br>

<h4>Quality Weights</h4>
Momentum <input class="slider" type="range" min="0" max="50" id="wMomentum" value="20"><br>
Volume <input class="slider" type="range" min="0" max="50" id="wVolume" value="15"><br>
PMH <input class="slider" type="range" min="0" max="50" id="wPMH" value="20"><br>

<label><input type="checkbox" id="soundToggle" checked> üîî Sound</label><br>

<label>
Auto Scan 
<input id="autoMinutes" type="number" value="3" style="width:60px"> min
<input type="checkbox" id="autoScan">
</label><br>

<button onclick="saveSettings()">Save</button>
<button onclick="scan()">Scan Now</button>
<button onclick="exportCSV()">Export CSV</button>

<p id="session"></p>
<progress id="progressBar" value="0" max="100"></progress>
<p id="progressText"></p>
<p id="leader"></p>

<div>
  <span class="tab active" onclick="showTab('resultsTab',this)">Results</span>
  <span class="tab" onclick="showTab('leaderTab',this)">Leaderboard</span>
  <span class="tab" onclick="showTab('historyTab',this)">History</span>
</div>

<div id="resultsTab"></div>
<div id="leaderTab" class="hidden"></div>
<div id="historyTab" class="hidden"></div>

<audio id="alertSound">
<source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg">
</audio>

<script>
const MOVERS_LIST=[
"SMFL","DRCT","TWG","GNS","MULN","NKLA","TOP","VVOS","PTPI",
"AMC","GME","ATER","CEI","TTOO","CVNA","HKD","MARA","RIOT","SIRI","SOFI"
];

let history=[], leaderboardData={}, pmhTracker={}, cooldown={}, resultsData=[];
let autoTimer=null;

apiKey.value=localStorage.getItem("APIKEY")||"";
pricePreset.value=localStorage.getItem("PRICE")||10;
minVol.value=localStorage.getItem("MINVOL")||1000;
sessionFilter.value=localStorage.getItem("SESSION")||"ALL";
soundToggle.checked=localStorage.getItem("SOUND")!=="0";
autoMinutes.value=localStorage.getItem("AUTOMIN")||3;
autoScan.checked=localStorage.getItem("AUTO")==="1";
wMomentum.value=localStorage.getItem("WMOM")||20;
wVolume.value=localStorage.getItem("WVOL")||15;
wPMH.value=localStorage.getItem("WPMH")||20;

if(autoScan.checked) startAuto();

function saveSettings(){
localStorage.setItem("APIKEY",apiKey.value);
localStorage.setItem("PRICE",pricePreset.value);
localStorage.setItem("MINVOL",minVol.value);
localStorage.setItem("SESSION",sessionFilter.value);
localStorage.setItem("SOUND",soundToggle.checked?"1":"0");
localStorage.setItem("AUTOMIN",autoMinutes.value);
localStorage.setItem("AUTO",autoScan.checked?"1":"0");
localStorage.setItem("WMOM",wMomentum.value);
localStorage.setItem("WVOL",wVolume.value);
localStorage.setItem("WPMH",wPMH.value);
alert("Saved");
}

function showTab(id,el){
document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
el.classList.add("active");
resultsTab.classList.add("hidden");
leaderTab.classList.add("hidden");
historyTab.classList.add("hidden");
document.getElementById(id).classList.remove("hidden");
}

autoScan.onchange=()=>{ autoScan.checked?startAuto():clearInterval(autoTimer); }
function startAuto(){ clearInterval(autoTimer); autoTimer=setInterval(scan, autoMinutes.value*60000); }

function getSession(){
const d=new Date(new Date().toLocaleString("en-US",{timeZone:"America/New_York"}));
const t=d.getHours()*60+d.getMinutes();
if(t>=240&&t<570) return "PRE";
if(t>=570&&t<960) return "OPEN";
if(t>=960&&t<1200) return "AFTER";
return "CLOSED";
}

function timeoutFetch(url,ms=4000){
return Promise.race([fetch(url).then(r=>r.json()), new Promise((_,rej)=>setTimeout(()=>rej("timeout"),ms))]);
}

async function getSymbols(key){
let symbols=[];
try{
const news=await timeoutFetch(`https://finnhub.io/api/v1/news?category=general&token=${key}`);
news.slice(0,8).forEach(n=>{
if(n.related) symbols.push(n.related.split(",")[0]);
});
}catch(e){}
symbols=symbols.concat(MOVERS_LIST);
return [...new Set(symbols)].slice(0,12);
}

async function scan(){
resultsTab.innerHTML="";
leaderTab.innerHTML="";
historyTab.innerHTML="";
leader.innerText="";
progressText.innerText="Scanning...";
progressBar.value=0;
resultsData=[];

const key=apiKey.value.trim();
if(!key){alert("Enter API key");return;}

const session=getSession();
sessionEl.innerText="Session: "+session;

if(sessionFilter.value!=="ALL" && sessionFilter.value!==session){
progressText.innerText="Session filtered";
return;
}

const symbols=await getSymbols(key);
let best=null, done=0, html="";

for(let rawSym of symbols){
const sym=rawSym.trim().toUpperCase();

// HARD symbol filter only
if(sym.endsWith("D")||sym.includes(".")||sym.length>5||!/^[A-Z]{1,5}$/.test(sym)) continue;

done++;
progressBar.value=Math.round(done/symbols.length*100);
progressText.innerText=`Scanning ${sym}`;

try{
const q=await timeoutFetch(`https://finnhub.io/api/v1/quote?symbol=${sym}&token=${key}`);
if(!q||!q.c) continue;
if(q.c>pricePreset.value || q.v<minVol.value) continue;

if(!pmhTracker[sym]) pmhTracker[sym]=q.c;
pmhTracker[sym]=Math.max(pmhTracker[sym],q.c);
const pmhBreak=q.c>=pmhTracker[sym];

let breakdown=[],score=0;
if(q.dp>2){score+=+wMomentum.value;breakdown.push("Momentum");}
if(q.v>10000){score+=+wVolume.value;breakdown.push("Volume");}
if(pmhBreak){score+=+wPMH.value;breakdown.push("PMH");}

let status=score>=60?"hot":score>=40?"warm":"watch";

if(status==="hot"&&!cooldown[sym]){
if(soundToggle.checked) alertSound.play();
cooldown[sym]=Date.now();
}

leaderboardData[sym]=Math.max(leaderboardData[sym]||0,score);
history.unshift(`${new Date().toLocaleTimeString()} ${sym} Score:${score}`);
history=history.slice(0,20);

if(!best||q.dp>best.dp) best={sym,dp:q.dp};

resultsData.push({sym,price:q.c,change:q.dp,vol:q.v,score});

html+=`
<div class="card ${status}">
<b>${sym} $${q.c.toFixed(2)}</b><br>
Change:${q.dp}% Vol:${q.v}<br>
Score:${score}<br>
<small>${breakdown.join(", ")}</small><br>
<a href="https://www.tradingview.com/chart/?symbol=${sym}" target="_blank">üìä Chart</a>
</div>`;
}catch(e){}
}

leader.innerText=best?`üî• Leader: ${best.sym} (${best.dp.toFixed(2)}%)`:"";
resultsTab.innerHTML=html||"No stocks found";
leaderTab.innerHTML=Object.entries(leaderboardData).sort((a,b)=>b[1]-a[1]).slice(0,5).map(x=>`<div class="card warm">${x[0]} ‚Äî ${x[1]}</div>`).join("");
historyTab.innerHTML=history.map(x=>`<div class="card">${x}</div>`).join("");
progressText.innerText="Scan complete";
}

function exportCSV(){
if(resultsData.length===0){alert("No data");return;}
let csv="Symbol,Price,Change,Volume,Score\n";
resultsData.forEach(r=>csv+=`${r.sym},${r.price},${r.change},${r.vol},${r.score}\n`);
const blob=new Blob([csv],{type:"text/csv"});
const a=document.createElement("a");
a.href=URL.createObjectURL(blob);
a.download="scanner_results.csv";
a.click();
}

const sessionEl=document.getElementById("session");
const resultsTab=document.getElementById("resultsTab");
const leaderTab=document.getElementById("leaderTab");
const historyTab=document.getElementById("historyTab");
const leader=document.getElementById("leader");
const progressText=document.getElementById("progressText");
const progressBar=document.getElementById("progressBar");
</script>

</body>
</html>
