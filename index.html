<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Penny Scanner PRO v30</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
:root{
  --bg:#020617; --card:#0f172a; --text:#fff; --accent:#3b82f6;
}
.light{
  --bg:#f3f4f6; --card:#ffffff; --text:#020617; --accent:#2563eb;
}
body{font-family:Arial;background:var(--bg);color:var(--text);margin:0;padding:10px;text-align:center}
button,input,select{padding:10px;border-radius:8px;border:none;margin:5px}
button{background:var(--accent);color:white;font-weight:bold}
.card{background:var(--card);margin:10px;padding:12px;border-radius:12px;text-align:left}
.hot{border-left:5px solid #22c55e}
.warm{border-left:5px solid orange}
.watch{border-left:5px solid #38bdf8}
#errorLog{color:#f87171;font-size:12px}
.settings{background:var(--card);padding:10px;border-radius:12px;margin-bottom:10px}
small{opacity:.7}
</style>
</head>
<body>

<h1>üìà Penny Scanner PRO v30</h1>

<button onclick="toggleSettings()">‚öôÔ∏è Settings</button>
<div id="settings" class="settings" style="display:none">

<input id="finnhubKey" placeholder="Finnhub API Key"/><br>

<label>Price Preset</label><br>
<select id="pricePreset">
  <option value="1">Under $1</option>
  <option value="5">Under $5</option>
  <option value="10" selected>Under $10</option>
</select><br>

<label>Min Volume</label><br>
<input id="minVol" type="number" value="5000"/><br>

<label>Session Filter</label><br>
<select id="sessionFilter">
  <option value="ALL">All</option>
  <option value="PRE">Pre-Market</option>
  <option value="OPEN">Market Open</option>
  <option value="AFTER">After Hours</option>
</select><br>

<label><input type="checkbox" id="autoScan"> Auto Scan</label><br>
<label><input type="checkbox" id="lightMode"> Light Mode</label><br>

<button onclick="saveSettings()">Save Settings</button>
</div>

<button onclick="scan()">Scan Now</button>
<button onclick="exportCSV()">Export CSV</button>

<p id="session"></p>
<p id="progress"></p>
<p id="leader"></p>

<h3>üì∞ News Catalysts</h3>
<div id="newsPanel"></div>

<h3>üèÜ Leaderboard</h3>
<div id="leaderboard"></div>

<h3>üìú History</h3>
<div id="history"></div>

<h3>‚ö†Ô∏è Errors</h3>
<div id="errorLog"></div>

<hr>
<div id="results"></div>

<audio id="alertSound">
<source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg">
</audio>

<script>
const SYMBOL_UNIVERSE=[
"SMFL","DRCT","TWG","GNS","MULN","NKLA","TOP","JG","VVOS","PTPI",
"PBLA","SINT","CRKN","GFAI","NUWE","AGRI","CXAI","BTTR","BBAI","LUCY",
"AKTS","MARA","RIOT","PLUG","SNDL","BB","SPCE","NIO","LCID","RIVN",
"AMC","GME","BBIG","ATER","CTRM","CEI","MCOM","XELA","IDEX"
];

let universeIndex=parseInt(localStorage.getItem("universeIndex")||"0");
let history=[], leaderboard={}, cooldown={}, errors=[], resultsData=[];
let autoTimer=null;
const TIMEOUT=5000;

// load settings
finnhubKey.value=localStorage.getItem("FINNHUB_KEY")||"";
minVol.value=localStorage.getItem("MINVOL")||5000;
pricePreset.value=localStorage.getItem("PRICE")||10;
sessionFilter.value=localStorage.getItem("SESSION")||"ALL";

lightMode.checked=localStorage.getItem("LIGHT")==="1";
if(lightMode.checked) document.body.classList.add("light");

autoScan.checked=localStorage.getItem("AUTO")==="1";
if(autoScan.checked) startAuto();

function toggleSettings(){
  settings.style.display=settings.style.display==="none"?"block":"none";
}

function saveSettings(){
  localStorage.setItem("FINNHUB_KEY",finnhubKey.value.trim());
  localStorage.setItem("MINVOL",minVol.value);
  localStorage.setItem("PRICE",pricePreset.value);
  localStorage.setItem("SESSION",sessionFilter.value);
  localStorage.setItem("AUTO",autoScan.checked?"1":"0");
  localStorage.setItem("LIGHT",lightMode.checked?"1":"0");
  alert("Saved");
}

lightMode.onchange=()=>document.body.classList.toggle("light");

autoScan.onchange=()=>{
  if(autoScan.checked){startAuto();Notification.requestPermission();}
  else clearInterval(autoTimer);
};

function startAuto(){
  autoTimer=setInterval(scan,60000);
}

function getSession(){
  const d=new Date(new Date().toLocaleString("en-US",{timeZone:"America/New_York"}));
  const t=d.getHours()*60+d.getMinutes();
  if(t>=240&&t<570) return "PRE";
  if(t>=570&&t<960) return "OPEN";
  if(t>=960&&t<1200) return "AFTER";
  return "CLOSED";
}

function dailyReset(){
  const today=new Date().toLocaleDateString("en-US",{timeZone:"America/New_York"});
  if(localStorage.getItem("DAY")!==today){
    localStorage.setItem("DAY",today);
    history=[]; leaderboard={}; cooldown={};
  }
}

function calcRSI(closes){
  let gains=0, losses=0;
  for(let i=1;i<closes.length;i++){
    let diff=closes[i]-closes[i-1];
    if(diff>0) gains+=diff;
    else losses-=diff;
  }
  let rs = gains/(losses||1);
  return 100-(100/(1+rs));
}

function score(dp,vol,pmh,news,rsi){
  let s=0;
  if(dp>5)s+=30; else if(dp>2)s+=15;
  if(vol>50000)s+=20;
  if(pmh)s+=20;
  if(news)s+=20;
  if(rsi>60 && rsi<80) s+=10;
  return s;
}

function timeoutFetch(url){
  return Promise.race([
    fetch(url).then(r=>r.json()),
    new Promise((_,rej)=>setTimeout(()=>rej("timeout"),TIMEOUT))
  ]);
}

async function scan(){
  dailyReset();
  resultsData=[];
  const key=localStorage.getItem("FINNHUB_KEY");
  if(!key){alert("Enter Finnhub API key");return;}

  const session=getSession();
  sessionEl.innerText="Session: "+session;
  progress.innerText="Scanning...";
  results.innerHTML="";
  leader.innerText="";
  errorLog.innerHTML="";
  newsPanel.innerHTML="";
  errors=[];

  if(sessionFilter.value!=="ALL" && sessionFilter.value!==session){
    progress.innerText="Session filtered out";
    return;
  }

  const batch=SYMBOL_UNIVERSE.slice(universeIndex, universeIndex+12);
  universeIndex=(universeIndex+12)%SYMBOL_UNIVERSE.length;
  localStorage.setItem("universeIndex",universeIndex);

  let best=null, html="", done=0;

  for(const sym of batch){
    try{
      progress.innerText=`Scanning ${++done}/${batch.length}`;

      const quote=await timeoutFetch(`https://finnhub.io/api/v1/quote?symbol=${sym}&token=${key}`);
      const candles=await timeoutFetch(`https://finnhub.io/api/v1/stock/candle?symbol=${sym}&resolution=5&count=15&token=${key}`);
      const news=await timeoutFetch(`https://finnhub.io/api/v1/company-news?symbol=${sym}&from=2024-01-01&to=2026-12-31&token=${key}`);

      const maxPrice=parseFloat(pricePreset.value);
      if(!quote.c||quote.c>maxPrice||quote.v<minVol.value) continue;

      const closes=candles.c||[];
      const rsi=closes.length>=2?calcRSI(closes):50;
      const pmh=quote.dp>5;
      const hasNews=news.length>0;

      const sc=score(quote.dp,quote.v,pmh,hasNews,rsi);

      let status="WATCH";
      if(sc>=70)status="HOT";
      else if(sc>=50)status="WARM";

      if(status==="HOT"&&!cooldown[sym]){
        alertSound.play();
        if(Notification.permission==="granted"){
          new Notification("üî• HOT", {body:`${sym} ${quote.dp.toFixed(2)}% RSI:${rsi.toFixed(1)}`});
        }
        cooldown[sym]=Date.now();
      }

      leaderboard[sym]=Math.max(leaderboard[sym]||0,sc);
      history.unshift(`${new Date().toLocaleTimeString()} ${sym} ${sc}`);
      history=history.slice(0,20);

      if(hasNews){
        newsPanel.innerHTML+=`<div class="card watch"><b>${sym}</b>: ${news[0].headline}</div>`;
      }

      if(!best||quote.dp>best.dp) best={sym,dp:quote.dp};

      resultsData.push({sym,price:quote.c,change:quote.dp,vol:quote.v,score:sc,rsi:rsi});

      html+=`
      <div class="card ${status.toLowerCase()}">
        <b>${sym} $${quote.c.toFixed(2)}</b><br>
        Change:${quote.dp}% Vol:${quote.v}<br>
        RSI:${rsi.toFixed(1)} PMH:${pmh} News:${hasNews}<br>
        Score:${sc} (${dpBreakdown(quote.dp,quote.v,pmh,hasNews,rsi)})<br>
        <a href="https://www.tradingview.com/chart/?symbol=${sym}" target="_blank">üìä Chart</a>
      </div>`;
    }catch(e){
      errors.push(sym+" failed");
    }
  }

  if(best) leader.innerText="üî• Leader: "+best.sym+" ("+best.dp.toFixed(2)+"%)";

  renderHistory();
  renderLeaderboard();
  renderErrors();

  progress.innerText="Scan complete";
  results.innerHTML=html||"No penny stocks in this batch";
}

function dpBreakdown(dp,vol,pmh,news,rsi){
  let parts=[];
  if(dp>2) parts.push("Momentum");
  if(vol>50000) parts.push("Volume");
  if(pmh) parts.push("PMH");
  if(news) parts.push("News");
  if(rsi>60&&rsi<80) parts.push("RSI");
  return parts.join(", ");
}

function exportCSV(){
  if(resultsData.length===0){alert("No data to export");return;}
  let csv="Symbol,Price,Change%,Volume,RSI,Score\n";
  resultsData.forEach(r=>{
    csv+=`${r.sym},${r.price},${r.change},${r.vol},${r.rsi.toFixed(1)},${r.score}\n`;
  });
  const blob=new Blob([csv],{type:"text/csv"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download="scanner_results.csv";
  a.click();
}

function renderHistory(){
  historyEl.innerHTML=history.map(x=>`<div class="card watch">${x}</div>`).join("")||"No history yet";
}
function renderLeaderboard(){
  leaderboardEl.innerHTML=Object.entries(leaderboard)
    .sort((a,b)=>b[1]-a[1]).slice(0,5)
    .map(x=>`<div class="card warm">${x[0]} ‚Äî ${x[1]}</div>`).join("")||"No leaders yet";
}
function renderErrors(){
  errorLog.innerHTML=errors.join("<br>")||"No errors";
}

const sessionEl=document.getElementById("session");
const progress=document.getElementById("progress");
const results=document.getElementById("results");
const historyEl=document.getElementById("history");
const leaderboardEl=document.getElementById("leaderboard");
const leader=document.getElementById("leader");
const errorLog=document.getElementById("errorLog");
const alertSound=document.getElementById("alertSound");
const newsPanel=document.getElementById("newsPanel");
</script>

</body>
</html>
