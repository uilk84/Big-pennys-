<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Penny Scanner â€” Auto Worker Fallback</title>
<style>
:root{--bg:#061018;--panel:#0f1724;--muted:#9ca3af;--text:#e6eef8;--accent:#38bdf8}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
.container{padding:14px;max-width:980px;margin:0 auto}
h1{margin:0 0 12px;font-size:1.6rem}
.controls{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:10px;align-items:center}
.controls button,input,label,select{background:var(--panel);color:var(--text);border:none;padding:8px 10px;border-radius:10px}
.small{color:var(--muted);font-size:13px;margin-bottom:10px}
.card{background:var(--panel);padding:12px;border-radius:12px;margin-bottom:12px;border:1px solid rgba(255,255,255,0.03)}
.sym{font-weight:800;color:var(--accent);font-size:1.05rem}
.hot{border-left:4px solid #22c55e}
.warm{border-left:4px solid #eab308}
.watch{border-left:4px solid #64748b}
.news a{color:#7cc7ff;font-weight:600;text-decoration:none}
@media(max-width:820px){table{display:none} #cards{display:block}}
table{width:100%;border-collapse:collapse;font-size:14px}
th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left}
th{color:var(--muted)}
.progress{height:6px;background:rgba(255,255,255,0.03);border-radius:6px;overflow:hidden;margin:6px 0}
.progress > div{height:100%;width:0;background:linear-gradient(90deg,#2dd4bf,#3b82f6);transition:width .25s}
</style>
</head>
<body>
<div class="container">
  <h1>Penny Scanner â€” Auto Worker Fallback</h1>

  <div class="controls">
    <button id="soundBtn">ðŸ”” ON</button>
    <label>MinVol <input id="minVol" type="number" value="100000" style="width:110px"></label>
    <label><input id="showAll" type="checkbox" checked> Show All</label>
    <button id="demoBtn">Force Demo</button>
  </div>

  <div class="small" id="status">Initializingâ€¦</div>
  <div class="progress" aria-hidden="true"><div id="prog"></div></div>

  <div id="leader" class="small" style="display:none;margin-top:8px"></div>
  <div id="cards" aria-live="polite"></div>

  <audio id="beep"><source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>
</div>

<script>
/* ---------- candidate worker URLs (auto-fallback) ---------- */
/* These are the worker hostnames we've seen in your account screenshots */
const FEED_CANDIDATES = [
  "https://holy-mouse-bba2.jasonuilkie84.workers.dev/",
  "https://nameless-bush-264e.jasonuilkie84.workers.dev/",
  "https://pennystock.jasonuilkie84.workers.dev/"
];

/* ---------- DOM ---------- */
const statusEl = document.getElementById('status');
const prog = document.getElementById('prog');
const cards = document.getElementById('cards');
const leaderEl = document.getElementById('leader');
const soundBtn = document.getElementById('soundBtn');
const minVol = document.getElementById('minVol');
const showAll = document.getElementById('showAll');
const demoBtn = document.getElementById('demoBtn');
const beep = document.getElementById('beep');

let sound = true;
soundBtn.onclick = ()=>{ sound = !sound; soundBtn.textContent = sound ? 'ðŸ”” ON' : 'ðŸ”• OFF' }

demoBtn.onclick = ()=>{ forcedDemo = true; statusEl.textContent='Demo forced by user'; scan(); }

let forcedDemo = false;
let activeFeedURL = null;
let pmh = {}, alerted = {};

/* ---------- demo fallback data ---------- */
const demoFeed = [
  { symbol:'TWG', title:'TWG press release â€” product launch', url:'#', vol:1200000 },
  { symbol:'SMOVE', title:'SMOVE soars after news', url:'#', vol:800000 },
  { symbol:'DRCT', title:'DRCT heavy volume after announcement', url:'#', vol:450000 },
  { symbol:'TRUE', title:'TRUE mentions strong results', url:'#', vol:250000 }
];

/* ---------- try candidate feeds in order with timeout ---------- */
async function tryFeeds(){
  statusEl.textContent = 'Trying feedsâ€¦';
  prog.style.width = '0%';
  for(let i=0;i<FEED_CANDIDATES.length;i++){
    const url = FEED_CANDIDATES[i];
    statusEl.textContent = `Trying feed ${i+1}/${FEED_CANDIDATES.length}: ${url}`;
    prog.style.width = ((i/(FEED_CANDIDATES.length))*100)+'%';
    try{
      const data = await fetchWithTimeout(url, 7000);
      if(!data) throw new Error('no response');
      // try parse json
      try {
        const parsed = await data.json();
        if(Array.isArray(parsed) && parsed.length>0){
          activeFeedURL = url;
          statusEl.textContent = `Using worker: ${url}`;
          prog.style.width = '100%';
          return parsed;
        }
      } catch(e){ throw new Error('invalid json'); }
    } catch(err){
      // continue to next
      statusEl.textContent = `Feed failed: ${url} (${err.message})`;
      await sleep(300); // small pause before next
      continue;
    }
  }
  // none succeeded
  statusEl.textContent = 'No live feed; using demo fallback';
  activeFeedURL = null;
  prog.style.width = '100%';
  return null;
}

/* small helper: fetch with timeout */
function fetchWithTimeout(url, ms){
  return new Promise((resolve, reject) => {
    const id = setTimeout(()=>{ reject(new Error('timeout')) }, ms);
    fetch(url, {cache:'no-store'}).then(res=>{
      clearTimeout(id);
      resolve(res);
    }).catch(err=>{
      clearTimeout(id);
      reject(err);
    })
  });
}

function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

/* ---------- rendering ---------- */
function renderCard(sym,title,url,vol,cls,txt){
  const el = document.createElement('div');
  el.className = 'card ' + cls;
  el.innerHTML = `<div class="sym"><a target="_blank" href="https://www.tradingview.com/symbols/${encodeURIComponent(sym)}">${sym}</a> ${(vol?('$'+(vol).toLocaleString()):'')}</div>
                  <div style="margin-top:8px">${url?`<a target="_blank" href="${url}">${title}</a>`:title}</div>
                  <div style="margin-top:8px;color:${cls==='hot'?'#22c55e':(cls==='warm'?'#eab308':'#9ca3af')}">Status: ${txt}</div>`;
  cards.appendChild(el);
}

/* ---------- main scan: attempts live, falls back to demo ---------- */
async function scan(){
  cards.innerHTML = '';
  leaderEl.style.display = 'none';
  prog.style.width = '0%';
  statusEl.textContent = 'Scanningâ€¦';

  let items = null;
  if(!forcedDemo){
    // if we already have activeFeedURL, try it first
    if(activeFeedURL){
      try{
        const r = await fetchWithTimeout(activeFeedURL,7000);
        const j = await r.json();
        if(Array.isArray(j) && j.length) items = j;
      }catch(e){
        // clear active feed and try all candidates
        activeFeedURL = null;
      }
    }
    if(!items){
      const live = await tryFeeds();
      if(live) items = live;
    }
  }

  if(!items) items = demoFeed;

  let leaders = [], shown = 0;
  for(let i=0;i<items.length;i++){
    const it = items[i];
    const sym = (it.symbol || (it.tickers&&it.tickers[0]) || it.ticker || it.symbol)?.toString().toUpperCase?.() || 'N/A';
    const title = it.title || it.t || it.headline || 'No headline';
    const url = it.url || it.link || '#';
    const vol = it.vol || Math.floor(100000 + Math.random()*900000);

    pmh[sym] = (pmh[sym]||0)+1;
    const broke = pmh[sym] > 2;

    let score = 0;
    if(vol >= (+minVol.value || 100000)) score++;
    if(title.toLowerCase().includes('surge')||title.toLowerCase().includes('soar')||title.toLowerCase().includes('press')||title.toLowerCase().includes('jump')) score++;
    if(broke) score++;

    let cls='watch', txt='WATCH';
    if(score==2){ cls='warm'; txt='WARM' }
    if(score>=3){ cls='hot'; txt='HOT'; leaders.push(sym) }

    if(!showAll.checked && cls==='watch') continue;
    if(vol < (+minVol.value || 100000) && !showAll.checked) continue;

    renderCard(sym,title,url,vol,cls,txt);
    shown++;

    if(cls==='hot' && !alerted[sym] && sound){
      beep.play();
      navigator.vibrate?.([200,100,200]);
      alerted[sym] = 1;
    }
  }

  if(leaders.length){
    leaderEl.style.display = 'block';
    leaderEl.textContent = 'Leaders: ' + [...new Set(leaders)].slice(0,5).join(' â€¢ ');
  }

  statusEl.textContent = activeFeedURL ? `Live feed OK â€” ${shown} shown (via ${activeFeedURL})` : `Demo feed â€” ${shown} shown`;
}

/* ---------- lifecycle ---------- */
scan();
setInterval(scan,30000);

/* ---------- wake lock best-effort ---------- */
async function requestWakeLock(){
  try{ if('wakeLock' in navigator) await navigator.wakeLock.request('screen'); }catch(e){}
}
requestWakeLock();
document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') requestWakeLock(); });

</script>
</body>
</html>
