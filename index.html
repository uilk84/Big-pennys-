<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PennyS Scanner â€“ Auto Feed</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
body{margin:0;font-family:-apple-system;background:#061018;color:#f1f5f9}
h1{margin:10px}
.controls{display:flex;flex-wrap:wrap;gap:8px;padding:10px}
button,input,label{background:#0f1724;color:#fff;border:none;border-radius:10px;padding:8px 10px}
.small{font-size:13px;opacity:.8;padding:0 10px}

table{width:100%;border-collapse:collapse;font-size:14px}
th,td{padding:10px;border-bottom:1px solid #1f2937;text-align:left}
th{opacity:.8}
.aplus{background:rgba(34,197,94,.25)}
.bsetup{background:rgba(234,179,8,.18)}
.skip{opacity:.4}
.good{color:#22c55e;font-weight:700}
.bad{color:#ef4444;font-weight:700}

/* FIXED NEWS COLOR */
.news a{
  color:#60a5fa;
  font-weight:600;
  text-decoration:none;
}
.news a:hover{color:#93c5fd}

#cards{display:none;padding:10px}
.card{
 background:#0f1724;
 border-radius:12px;
 padding:12px;
 margin-bottom:12px;
 box-shadow:0 0 6px rgba(0,0,0,.4)
}
.sym{font-weight:800;color:#38bdf8;font-size:18px}
.signal{font-weight:700}

@media(max-width:800px){
 table{display:none}
 #cards{display:block}
}
</style>
</head>

<body>
<h1>PennyS Scanner</h1>

<div class="controls">
<button id="soundBtn">ðŸ”” ON</button>
<label><input type="checkbox" id="pre"> PM</label>
<label><input type="checkbox" id="post"> AH</label>

<button onclick="preset('lotto')">ðŸŽ°</button>
<button onclick="preset('scalp')">âš¡</button>
<button onclick="preset('momentum')">ðŸš€</button>

<label>Min <input id="minPrice" type="number" value="1"></label>
<label>Max <input id="maxPrice" type="number" value="10"></label>
<label>Risk <input id="riskPerTrade" type="number" value="100"></label>
</div>

<div class="small">
Session: <span id="session"></span> | Feed: <span id="feedLabel"></span> | Next feed in <span id="timer">20</span>s
</div>

<table>
<thead>
<tr>
<th>Sym</th><th>Price</th><th>PMH</th><th>Vol</th><th>News</th><th>Score</th><th>Signal</th>
</tr>
</thead>
<tbody id="rows"><tr><td colspan="7">Waitingâ€¦</td></tr></tbody>
</table>

<div id="cards"></div>

<audio id="beep">
<source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg">
</audio>

<script>
/* ===== Wake Lock ===== */
let wakeLock=null;
async function requestWakeLock(){
 try{ if("wakeLock" in navigator) wakeLock=await navigator.wakeLock.request("screen"); }catch(e){}
}
requestWakeLock();
document.addEventListener("visibilitychange",()=>{ if(document.visibilityState==="visible") requestWakeLock(); });

const rows=document.getElementById("rows");
const cards=document.getElementById("cards");
const beep=document.getElementById("beep");
const soundBtn=document.getElementById("soundBtn");
const sessionEl=document.getElementById("session");
const feedLabel=document.getElementById("feedLabel");
const timerEl=document.getElementById("timer");

let sound=true;
let pmh={}, lastPrice={}, lastVol={}, alerted={}, newsCache={};
let cooldownUntil=0;

/* Daily reset */
let lastTradingDate=localStorage.getItem("lastTradingDate");
function checkNewDay(){
 const today=new Date().toLocaleDateString("en-US",{timeZone:"America/New_York"});
 if(lastTradingDate!==today){
  pmh={}; lastPrice={}; lastVol={}; alerted={}; newsCache={};
  lastTradingDate=today;
  localStorage.setItem("lastTradingDate",today);
 }
}

/* Feeds (AUTO ROTATE) */
const feeds=["day_gainers","most_actives","small_cap_gainers"];
let feedIndex=0;

/* News */
const PR_SOURCES=["globenewswire","prnewswire","businesswire","accesswire"];
const NEWS_TTL=5*60*1000;

soundBtn.onclick=()=>{sound=!sound;soundBtn.textContent=sound?"ðŸ”” ON":"ðŸ”• OFF"}

function preset(p){
 if(p==="lotto"){minPrice.value=.1;maxPrice.value=1}
 if(p==="scalp"){minPrice.value=.3;maxPrice.value=3}
 if(p==="momentum"){minPrice.value=1;maxPrice.value=10}
 scan();
}

function session(){
 const d=new Date(new Date().toLocaleString("en-US",{timeZone:"America/New_York"}))
 const h=d.getHours()+d.getMinutes()/60
 if(h>=4&&h<9.5) return "PM"
 if(h>=9.5&&h<16) return "RTH"
 if(h>=16&&h<=20) return "AH"
 return "CLOSED"
}
function allowed(){
 const s=session()
 if(s==="PM") return pre.checked
 if(s==="RTH") return true
 if(s==="AH") return post.checked
 return false
}

async function getNews(sym){
 const now=Date.now();
 if(newsCache[sym]&&(now-newsCache[sym].time)<NEWS_TTL) return newsCache[sym]
 try{
  const r=await fetch(`https://corsproxy.io/?https://query1.finance.yahoo.com/v1/finance/search?q=${sym}`)
  const j=await r.json()
  if(j.news&&j.news.length){
   const n=j.news[0]
   const isPR=PR_SOURCES.some(src=>n.title.toLowerCase().includes(src))
   newsCache[sym]={title:n.title,url:n.link,isPR:isPR,time:now}
   return newsCache[sym]
  }
 }catch{}
 return null
}

/* Timer */
let t=20;
setInterval(()=>{
 t--; if(t<=0) t=20;
 timerEl.textContent=t;
},1000);

async function scan(){
 checkNewDay()
 if(Date.now()<cooldownUntil) return

 sessionEl.textContent=session()
 if(!allowed()){
  rows.innerHTML="<tr><td colspan=7>Session blocked</td></tr>"
  cards.innerHTML=""
  return
 }

 const min=+minPrice.value||1
 const max=+maxPrice.value||10
 const riskMax=+riskPerTrade.value||100

 const feed=feeds[feedIndex];
 feedLabel.textContent=feed;
 feedIndex=(feedIndex+1)%feeds.length; // FORCE ROTATION
 t=20;

 try{
  const r=await fetch(`https://corsproxy.io/?https://query1.finance.yahoo.com/v1/finance/screener/predefined/saved?count=30&scrIds=${feed}`)
  const q=(await r.json()).finance.result[0].quotes

  rows.innerHTML=""
  cards.innerHTML=""

  for(const tkr of q){
   const s=tkr.symbol
   const p=tkr.regularMarketPrice
   const v=tkr.regularMarketVolume||0

   if(!s||!p) continue
   if(p<min||p>max) continue
   if(v<200000) continue

   const prevV=lastVol[s]||v
   lastVol[s]=v

   if(session()==="PM") pmh[s]=Math.max(pmh[s]||0,p)

   const hasPMH=pmh[s]>0
   const volAccel=v>prevV*1.3
   const newsObj=await getNews(s)
   const hasPR=newsObj&&newsObj.isPR

   let score=0
   if(hasPR) score+=3
   if(hasPMH) score+=2
   if(volAccel) score+=2

   let sig="SKIP",cls="skip"
   if(score>=7){sig="A+ SETUP";cls="aplus"}
   else if(score>=4){sig="B SETUP";cls="bsetup"}

   rows.innerHTML+=`
   <tr class="${cls}">
    <td>${s}</td>
    <td>$${p.toFixed(2)}</td>
    <td>${hasPMH?pmh[s].toFixed(2):"-"}</td>
    <td>${(v/1e6).toFixed(2)}M</td>
    <td class="news">${newsObj?`<a target=_blank href="${newsObj.url}">${newsObj.title}</a>`:"â€”"}</td>
    <td>${score}</td>
    <td>${sig}</td>
   </tr>`

   cards.innerHTML+=`
   <div class="card ${cls}">
    <div class="sym">${s} $${p.toFixed(2)}</div>
    <div class="news">${newsObj?`<a target=_blank href="${newsObj.url}">${newsObj.title}</a>`:"â€”"}</div>
    <div>Score: ${score} | ${sig}</div>
   </div>`

   if(sig==="A+ SETUP"&&!alerted[s]&&sound){
    beep.play()
    navigator.vibrate?.([200,100,200])
    alerted[s]=1
    cooldownUntil=Date.now()+300000
   }
  }

  if(!rows.children.length){
   rows.innerHTML="<tr><td colspan=7>No setups</td></tr>"
   cards.innerHTML=""
  }

 }catch{
  rows.innerHTML="<tr><td colspan=7>Feed error</td></tr>"
 }
}

scan()
setInterval(scan,20000)
</script>
</body>
</html>
