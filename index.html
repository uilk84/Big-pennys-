<script>
/* ================== STATE ================== */
const rows = document.getElementById("rows");
let soundEnabled = false;

/* ================== SOUND ================== */
function enableSound(){
  soundEnabled = true;
  const beep = document.getElementById("beep");
  beep.play().catch(()=>{});
  navigator.vibrate?.([150,80,150]);
}

/* ================== TIME (US/EASTERN) ================== */
function easternMinutes(){
  const now = new Date();
  const est = new Date(
    now.toLocaleString("en-US", { timeZone: "America/New_York" })
  );
  return est.getHours() * 60 + est.getMinutes();
}

function inMarket(){ return easternMinutes() >= 570 && easternMinutes() <= 960; }
function inPremarket(){ return easternMinutes() >= 240 && easternMinutes() < 570; }
function inPost(){ return easternMinutes() > 960 && easternMinutes() <= 1200; }

/* ================== MAIN SCAN ================== */
async function loadData(){
  const pm = document.getElementById("premarket").checked;
  const post = document.getElementById("postmarket").checked;

  const allowed =
    inMarket() ||
    (pm && inPremarket()) ||
    (post && inPost());

  if(!allowed){
    rows.innerHTML =
      "<tr><td colspan='5'>Market closed</td></tr>";
    return;
  }

  rows.innerHTML =
    "<tr><td colspan='5'>Scanning moversâ€¦</td></tr>";

  try {
    const res = await fetch(
      "https://corsproxy.io/?https://query1.finance.yahoo.com/v1/finance/screener/predefined/saved?count=50&scrIds=day_gainers"
    );

    const data = await res.json();
    const list = data?.finance?.result?.[0]?.quotes || [];

    rows.innerHTML = "";

    list.forEach(t => {
      if(!t.symbol) return;
      if(!t.regularMarketPrice) return;
      if(t.regularMarketPrice > 10) return;

      const vol = t.regularMarketVolume || 0;
      if(vol < 500000) return;

      const score = Math.min(100, Math.floor(vol / 100000));
      const type = inMarket() ? "Market" : inPremarket() ? "PM" : "AH";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${t.symbol}</td>
        <td>${t.regularMarketPrice.toFixed(2)}</td>
        <td>${score}</td>
        <td>${vol.toLocaleString()}</td>
        <td>${type}</td>
      `;
      rows.appendChild(tr);

      if(soundEnabled){
        document.getElementById("beep").play().catch(()=>{});
        navigator.vibrate?.([200,100,200]);
      }
    });

    if(!rows.children.length){
      rows.innerHTML =
        "<tr><td colspan='5'>No qualifying penny movers</td></tr>";
    }

  } catch (err) {
    rows.innerHTML =
      "<tr><td colspan='5'>Feed error</td></tr>";
  }
}

/* ================== AUTO RUN ================== */
loadData();
setInterval(loadData, 30000);
</script>
