<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Penny Scanner v4 â€” Volume fix</title>
<style>
  :root{--bg:#071025;--card:#0b1220;--muted:#99a6b3;--text:#e6eef6;--accent:#00d1a6}
  body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;background:linear-gradient(#071025,#0b1220);color:var(--text);padding:18px}
  h1{margin:0 0 12px;font-size:28px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
  .pill, .btn{background:#0e1b26;border-radius:12px;padding:8px 12px;color:var(--text);border:none}
  input, select{background:#08121a;border:1px solid rgba(255,255,255,0.03);color:var(--text);padding:8px;border-radius:8px}
  .small{font-size:13px;color:var(--muted)}
  .bar{height:6px;border-radius:6px;background:linear-gradient(90deg,#2dd4bf,#60a5fa);margin:10px 0;width:0%}
  .card{background:var(--card);padding:14px;border-radius:10px;margin:10px 0;box-shadow:0 6px 20px rgba(0,0,0,0.45)}
  .symbol{font-weight:800;color:#3ee0c6}
  .meta{color:var(--muted);margin-top:6px}
  .debug{background:#081018;padding:10px;border-radius:8px;color:#bfeaf0;white-space:pre-wrap;max-height:220px;overflow:auto;margin-top:10px;font-family:monospace;font-size:13px}
  .warn{color:#ffcc66}
  @media (max-width:520px){h1{font-size:22px}}
</style>
</head>
<body>
  <h1>ðŸ“ˆ Penny Scanner v4 â€” Volume fix</h1>

  <div class="controls">
    <button id="toggleSound" class="pill">ðŸ”” Sound: <span id="soundState">ON</span></button>
    <label class="pill"><input id="showAll" type="checkbox" checked style="margin-right:8px">Show All</label>
    <label class="pill"><input id="prOnly" type="checkbox" style="margin-right:8px">PR Only</label>
    <input id="minVol" type="number" value="100000" style="width:110px"/>
    <button id="scanNow" class="btn">Scan Now</button>
    <button id="forceDemo" class="btn">Force Demo</button>
  </div>

  <div class="controls">
    <label class="small">Prefetch Quotes:
      <input id="prefetchToggle" type="checkbox" style="margin-left:6px" />
    </label>
    <label class="small">Top:
      <input id="prefetchCount" type="number" value="3" style="width:60px;margin-left:6px"/>
    </label>
    <div style="flex:1"></div>
    <div id="feedLine" class="small">Feed: â€” | Next scan: â€”</div>
  </div>

  <div class="bar" id="prog"></div>
  <div id="leader" class="small" style="color:#00ffab;margin-top:6px">Leader: â€”</div>
  <div id="results"></div>

  <div id="apiStatus" class="small" style="margin-top:8px">API Status: idle</div>
  <pre id="debug" class="debug" style="display:none"></pre>

<script>
/* CONFIG */
const API_KEY = "PASTE_YOUR_FMP_KEY_HERE"; // <-- put your new FMP key here
const INTERVAL_MS = 25000; // scan every 25s
const FEEDS = [
  {label:'Top Gainers', url: `https://financialmodelingprep.com/stable/biggest-gainers?apikey=${API_KEY}`},
  {label:'Most Active', url: `https://financialmodelingprep.com/stable/most-active?apikey=${API_KEY}`},
  {label:'Press Releases', url: `https://financialmodelingprep.com/stable/press-releases?apikey=${API_KEY}`}
];
// NOTE: quote endpoint used for per-symbol volume fetch
const QUOTE_ENDPOINT = symbol => `https://financialmodelingprep.com/stable/quote/${encodeURIComponent(symbol)}?apikey=${API_KEY}`;

/* DOM */
const resultsEl = document.getElementById('results');
const apiStatusEl = document.getElementById('apiStatus');
const debugEl = document.getElementById('debug');
const prog = document.getElementById('prog');
const feedLine = document.getElementById('feedLine');
const leaderEl = document.getElementById('leader');

let feedIndex = 0;
let timer = null;
let useDemo = false;
let soundOn = true;

document.getElementById('toggleSound').onclick = ()=>{
  soundOn = !soundOn;
  document.getElementById('soundState').innerText = soundOn ? 'ON':'OFF';
};
document.getElementById('scanNow').onclick = runScanImmediate;
document.getElementById('forceDemo').onclick = ()=>{ useDemo=true; runScanImmediate(); };

function setProgress(p){ prog.style.width = Math.max(0,Math.min(100,p)) + '%'; }
function showDebug(txt){ debugEl.style.display='block'; debugEl.textContent = txt; }
function hideDebug(){ debugEl.style.display='none'; debugEl.textContent = ''; }

function normalizeVol(obj){
  // try many common fields
  return Number(obj.volume || obj.totalVolume || obj.latestVolume || obj.avgVolume || obj.dayVolume || obj.total_volume || obj.v || obj.vol || 0) || 0;
}

async function fetchJson(url){
  const res = await fetch(url, {cache:'no-store'});
  const txt = await res.text();
  try{ return {ok:res.ok, status:res.status, json: JSON.parse(txt), raw:txt}; }
  catch(e){ return {ok:res.ok, status:res.status, json:null, raw:txt}; }
}

async function doOneFeed(){
  if(!API_KEY || API_KEY.includes('PASTE_YOUR')) {
    apiStatusEl.innerText = 'API Status: NO API KEY â€” paste your FMP key into the file.';
    showDemo();
    return;
  }

  const feed = FEEDS[ feedIndex % FEEDS.length ];
  feedLine.innerText = `Feed: ${feed.label} | Next scan: ${INTERVAL_MS/1000}s`;
  setProgress(20);
  apiStatusEl.innerText = `API Status: fetching ${feed.label}...`;

  const r = await fetchJson(feed.url);
  setProgress(50);

  if(!r.ok){
    // show error text and try next feed fallback
    showDebug(`HTTP ${r.status}\n\n${r.raw}`);
    apiStatusEl.innerText = `API Status: HTTP ${r.status} â€” trying alt feeds or demo`;
    // try other feeds quickly
    for(let i=0;i<FEEDS.length;i++){
      if(i === (feedIndex % FEEDS.length)) continue;
      const alt = FEEDS[i];
      const rr = await fetchJson(alt.url);
      if(rr.ok){
        hideDebug();
        renderFromRaw(rr.json, alt.label);
        feedIndex = i; // move to alt
        setProgress(100);
        return;
      }
    }
    // else demo
    showDemo();
    setProgress(100);
    return;
  }

  hideDebug();
  apiStatusEl.innerText = `API Status: LIVE (${feed.label})`;
  // normalize and render
  renderFromRaw(r.json, feed.label);
  setProgress(100);
}

function showDemo(){
  const demo = [
    {symbol:'SMOVE', price:3.42, volume:800000, title:'SMOVE surges after press release'},
    {symbol:'TWG', price:5.11, volume:1200000, title:'TWG launches new product'},
    {symbol:'DRCT', price:2.95, volume:450000, title:'DRCT heavy volume after announcement'},
    {symbol:'TRUE', price:1.88, volume:250000, title:'TRUE reports earnings'}
  ];
  renderList(demo, 'Demo');
  apiStatusEl.innerText = 'API Status: DEMO (live failed)';
}

function renderFromRaw(raw, feedLabel){
  // raw might be an object with data array or an array
  let arr = [];
  if(Array.isArray(raw)) arr = raw;
  else if(raw && raw.data) arr = raw.data;
  else if(raw && typeof raw === 'object') {
    // sometimes feed uses keyed object; try to convert
    arr = Object.values(raw);
  } else arr = [];

  // map to common fields
  const mapped = arr.map(item=>{
    // FMP feed shapes vary; pick likely fields
    const symbol = item.symbol || item.ticker || item.code || item[0] || '';
    const price = item.price || item.close || item.last || (item.quote && item.quote.price) || 0;
    const vol = normalizeVol(item);
    const title = item.name || item.companyName || item.title || item.text || item.description || '';
    return { symbol, price, volume: vol, title, raw: item };
  });

  // If volumes are zero and prefetch enabled -> fetch per-symbol quotes for top N
  const prefetch = document.getElementById('prefetchToggle').checked;
  const prefetchCount = Math.max(0,Number(document.getElementById('prefetchCount').value || 0));
  if(prefetch && prefetchCount > 0){
    // pick top N symbols (first N in mapped)
    fetchQuotesForTopN(mapped.slice(0,prefetchCount)).then(updated => {
      // merge updated volumes back
      const merged = mapped.map(m=>{
        const u = updated.find(x=>x.symbol === m.symbol);
        return u ? {...m, volume: (u.volume || m.volume)} : m;
      });
      renderList(merged, feedLabel);
    }).catch(err=>{
      console.warn('prefetch failed',err);
      renderList(mapped, feedLabel);
    });
  } else {
    renderList(mapped, feedLabel);
  }
}

async function fetchQuotesForTopN(list){
  // careful â€” per-symbol calls consume rate limit. keep N small.
  const out = [];
  for(const it of list){
    if(!it.symbol) { out.push(it); continue; }
    try{
      const url = QUOTE_ENDPOINT(it.symbol);
      const r = await fetchJson(url);
      if(r.ok && Array.isArray(r.json) && r.json[0]){
        const q = r.json[0];
        const vol = normalizeVol(q);
        out.push({ symbol: it.symbol, volume: vol, price: q.price || it.price });
      } else {
        out.push(it);
      }
    }catch(e){
      out.push(it);
    }
    // small delay to reduce burst
    await new Promise(res=>setTimeout(res, 250));
  }
  return out;
}

function renderList(items, sourceLabel){
  resultsEl.innerHTML = '';
  const minVol = Number(document.getElementById('minVol').value || 0);
  const prOnly = document.getElementById('prOnly').checked;
  const showAll = document.getElementById('showAll').checked;

  // optionally filter PR only (we check title for 'press' keywords)
  const filtered = items.filter(it=>{
    if(!it) return false;
    const isPress = /press|release|announc/i.test(it.title || '');
    if(prOnly && !isPress) return false;
    if(!showAll && minVol && (it.volume || 0) < minVol) return false;
    return true;
  });

  if(filtered.length === 0){
    resultsEl.innerHTML = '<div class="card small">No stocks match filters</div>';
    leaderEl.innerText = 'Leader: â€”';
    return;
  }

  // leader = highest volume
  const leader = filtered.reduce((acc,cur)=> (cur.volume> (acc.volume||0) ? cur : acc), filtered[0]);
  leaderEl.innerText = 'Leader: ' + (leader.symbol || 'â€”');

  filtered.forEach(it=>{
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><div class="symbol">${escapeHtml(it.symbol)} <span style="color:#9ad7ff;font-weight:700">\$${formatPrice(it.price)}</span></div>
        <div class="meta">${escapeHtml(it.title)}</div>
        <div class="meta">Vol: ${formatVol(it.volume)} | Status: <strong>${statusFromVol(it.volume)}</strong></div></div>
        <div><a class="chartLink" href="https://finance.yahoo.com/quote/${encodeURIComponent(it.symbol)}/chart" target="_blank">ðŸ“ˆ Chart</a></div>
      </div>`;
    resultsEl.appendChild(card);
  });

  apiStatusEl.innerText = `API Status: ${sourceLabel} | ${filtered.length} shown`;
}

/* helpers */
function formatVol(v){
  if(!v) return '0';
  if(v>=1e9) return (v/1e9).toFixed(2)+'B';
  if(v>=1e6) return (v/1e6).toFixed(2)+'M';
  if(v>=1e3) return (v/1e3).toFixed(0)+'K';
  return v;
}
function formatPrice(p){return p?Number(p).toFixed(2):'0.00'}
function statusFromVol(v){ if(v>1e6) return 'HOT'; if(v>4e5) return 'WARM'; return 'WATCH' }
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function runLoop(){
  setProgress(0);
  doOneFeed().catch(e=>{
    console.error(e);
    showDemo();
  }).finally(()=>{
    // schedule next rotation
    feedIndex++;
    clearTimeout(timer);
    timer = setTimeout(runLoop, INTERVAL_MS);
    // animate progress to next
    let t=0; const step = 1000; const total = INTERVAL_MS;
    const interval = setInterval(()=>{
      t += step;
      const pct = Math.min(100, Math.round((t/total)*100));
      setProgress(pct);
      if(t>=total) clearInterval(interval);
    }, step);
  });
}
function runScanImmediate(){ clearTimeout(timer); runLoop(); }

// start
if(!API_KEY || API_KEY.includes('PASTE_YOUR')) {
  apiStatusEl.innerText = 'API Status: NO API KEY â€” paste your FMP key into API_KEY in the file.';
  showDemo();
} else {
  runLoop();
}

</script>
</body>
</html>
